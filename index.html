
<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krav Maga Woman</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Marcador: Estilos Globais */
        /* W3C: Define a fonte padrão e transições suaves para o corpo da página. */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Marcador: Variáveis de Tema (Light e Dark) */
        /* W3C: Variáveis CSS para o tema claro, ajustando cores do Bootstrap e customizadas. */
        [data-bs-theme="light"] {
            --bs-primary: #db2777; /* pink-600 */
            --bs-primary-rgb: 219, 39, 119;
            --bs-primary-hover: #c5226c; /* darker pink */
            --bs-secondary: #6c757d; /* default bs secondary */
            --bs-body-bg: #f0f2f5;
            --bs-body-color: #1f2937;
            --bs-border-color: #dee2e6;
            --custom-card-bg: #ffffff;
            --custom-card-color: #1f2937;
            --custom-input-bg: #ffffff;
            --custom-input-color: #111827;
            --custom-input-border: #ced4da;
            --custom-input-placeholder: #6B7280;
            --custom-nav-link-color: #374151;
            --custom-nav-link-hover-bg: #fbcfe8;
            --custom-nav-link-hover-color: #db2777;
            --custom-nav-active-bg: #db2777;
            --custom-nav-active-color: white;
            --custom-text-pink: #ec4899; /* pink-400 */
            --custom-text-muted-light: #4b5563; /* gray-600 */
            --custom-header-bg: #ffffff;
            --custom-header-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
            --custom-footer-bg: #e5e7eb;
            --custom-footer-color: #374151;
            --custom-loader-border: #e5e7eb;
            --custom-loader-border-top: #ec4899;
            --custom-modal-content-bg: #ffffff;
            --custom-modal-content-color: #1f2937;
            --custom-emergency-zone-bg: rgba(254, 226, 226, 1); /* bg-red-900 bg-opacity-30 light*/
            --custom-emergency-zone-border: #ef4444; /* border-red-500 light */
            --custom-emergency-zone-text: #b91c1c; /* text-red-300 light */
            --custom-emergency-zone-header: #dc2626; /* text-red-400 light */
            --custom-chat-bg: #f8f9fa;
            --custom-chat-user-msg-bg: #e9ecef;
            --custom-chat-bot-msg-bg: var(--bs-primary);
            --custom-chat-bot-msg-color: white;
            --custom-chat-input-bg: #ffffff;
            --community-chat-received-bg: #e9ecef;
            --community-chat-received-color: #1f2937;
            --community-chat-sent-bg: var(--bs-primary);
            --community-chat-sent-color: white;
        }

        /* W3C: Variáveis CSS para o tema escuro, ajustando cores do Bootstrap e customizadas. */
        [data-bs-theme="dark"] {
            --bs-primary: #ec4899; /* pink-500 */
            --bs-primary-rgb: 236, 72, 153;
            --bs-primary-hover: #d03c8a; /* darker pink */
            --bs-secondary: #6c757d; /* default bs secondary */
            --bs-body-bg: #1f2937; /* gray-800 */
            --bs-body-color: #d1d5db; /* gray-300 */
            --bs-border-color: #4b5563; /* gray-600 */
            --custom-card-bg: #374151; /* gray-700 */
            --custom-card-color: #d1d5db; /* gray-300 */
            --custom-input-bg: #374151; /* gray-700 */
            --custom-input-color: #ffffff;
            --custom-input-border: #4b5563; /* gray-600 */
            --custom-input-placeholder: #9ca3af; /* gray-400 */
            --custom-nav-link-color: #d1d5db; /* gray-300 */
            --custom-nav-link-hover-bg: #ec4899; /* pink-500 */
            --custom-nav-link-hover-color: white;
            --custom-nav-active-bg: #ec4899; /* pink-500 */
            --custom-nav-active-color: white;
            --custom-text-pink: #f472b6; /* pink-400 */
            --custom-text-muted-light: #9ca3af; /* gray-400 */
            --custom-header-bg: #111827; /* gray-900 */
            --custom-header-shadow: 0 1px 3px 0 rgba(0,0,0,0.25);
            --custom-footer-bg: #111827; /* gray-900 */
            --custom-footer-color: #9ca3af; /* gray-400 */
            --custom-loader-border: #4B5563; /* gray-600 */
            --custom-loader-border-top: #ec4899; /* pink-500 */
            --custom-modal-content-bg: #1f2937; /* gray-800 */
            --custom-modal-content-color: #d1d5db; /* gray-300 */
            --custom-emergency-zone-bg: rgba(153, 27, 27, 0.3); /* bg-red-900 bg-opacity-30 dark */
            --custom-emergency-zone-border: #ef4444; /* border-red-500 dark */
            --custom-emergency-zone-text: #f87171; /* text-red-300 dark */
            --custom-emergency-zone-header: #fca5a5; /* text-red-400 dark */
            --custom-chat-bg: #2c3e50; /* Um cinza azulado escuro */
            --custom-chat-user-msg-bg: #374151; /* gray-700 */
            --custom-chat-bot-msg-bg: var(--bs-primary);
            --custom-chat-bot-msg-color: white;
            --custom-chat-input-bg: #374151; /* gray-700 */
            --community-chat-received-bg: #4b5563; /* gray-600, slightly lighter than card bg */
            --community-chat-received-color: #d1d5db; /* gray-300 */
            --community-chat-sent-bg: var(--bs-primary);
            --community-chat-sent-color: white;
        }

        /* Marcador: Componentes - Loader */
        /* W3C: Estiliza o loader de carregamento da página. */
        .loader {
            border: 5px solid var(--custom-loader-border);
            border-top: 5px solid var(--custom-loader-border-top);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
        }
        /* W3C: Animação de rotação para o loader. */
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Marcador: Componentes - Visibilidade da Seção de Página */
        /* W3C: Define o estado inicial oculto para seções de página. */
        .page-section {
            display: none;
        }
        /* W3C: Estilos específicos para a página de autenticação quando ativa. */
        #auth-page.page-section {
             min-height: 100vh;
        }
        /* W3C: Exibe a página de autenticação com layout flexbox quando ativa. */
        #auth-page.page-section.active {
            display: flex;
        }
        /* W3C: Exibe outras seções de página como bloco quando ativas. */
        .page-section.active {
            display: block;
        }

        /* Marcador: Componentes - Card */
        /* W3C: Estilização customizada para elementos de card. */
        .card {
            background-color: var(--custom-card-bg);
            color: var(--custom-card-color);
            border: 1px solid var(--bs-border-color);
            transition: transform 0.2s ease-in-out;
        }
        /* W3C: Efeito de escala ao passar o mouse sobre o card. */
        .card:hover {
            transform: scale(1.03);
        }
        /* W3C: Cores para títulos de card e outros elementos textuais. */
        .card .card-title, .card h2, .card h3 {
            color: var(--custom-text-pink);
        }
        /* W3C: Estilo para texto com cor "muted light" dentro dos cards. */
        .card .text-muted-light {
            color: var(--custom-text-muted-light) !important;
        }

        /* Marcador: Componentes - Botão */
        /* W3C: Estilização para botões primários. */
        .btn-primary {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
        }
        /* W3C: Estilização para botões primários ao passar o mouse. */
        .btn-primary:hover {
            background-color: var(--bs-primary-hover);
            border-color: var(--bs-primary-hover);
        }
        /* W3C: Estilização para o botão de emergência ativo. */
        .btn-danger-active {
            background-color: #facc15; /* yellow-400 */
            border-color: #facc15;
            color: #1f2937; /* gray-800 */
        }
        /* W3C: Estilização para o botão de emergência ativo ao passar o mouse. */
        .btn-danger-active:hover {
            background-color: #eab308; /* yellow-500 */
            border-color: #eab308;
            color: #1f2937;
        }

        /* Marcador: Componentes - Campo de Entrada (Input) */
        /* W3C: Estilização customizada para campos de formulário. */
        .form-control {
            background-color: var(--custom-input-bg);
            color: var(--custom-input-color);
            border: 1px solid var(--custom-input-border);
        }
        /* W3C: Estilização para o texto do placeholder dos campos de formulário. */
        .form-control::placeholder {
            color: var(--custom-input-placeholder);
        }
        /* W3C: Estilização para campos de formulário em foco. */
        .form-control:focus {
            background-color: var(--custom-input-bg);
            color: var(--custom-input-color);
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
        }
        /* W3C: Estilização para áreas de texto de anotações. */
        .notes-area-view {
             background-color: var(--custom-input-bg);
            color: var(--custom-input-color);
            border: 1px solid var(--custom-input-border);
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            border-radius: 0.375rem;
        }

        /* Marcador: Layout - Cabeçalho */
        /* W3C: Estilização para o cabeçalho do aplicativo. */
        #appHeader {
            background-color: var(--custom-header-bg);
            box-shadow: var(--custom-header-shadow);
            position: sticky;
            top: 0;
            z-index: 1030;
        }
        /* W3C: Estilização para a marca do cabeçalho (logo/título). */
        #appHeader .navbar-brand { /* For the <a> tag */
            color: var(--bs-primary) !important;
            font-weight: bold;
            /* d-flex and align-items-center are already on the <a> tag in HTML */
        }
        /* W3C: Estilização para a imagem do logo na navbar. */
        .navbar-brand-logo { /* For the <img> tag inside navbar-brand */
            height: 150px; /* Adjusted size for navbar */
            width: auto;
            margin-right: 8px; /* Adds space if there was text, can be removed or kept for balance */
        }
        /* W3C: Estilização para links de navegação. */
        #appHeader .nav-link {
            color: var(--custom-nav-link-color);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
        }
        /* W3C: Estilização para links de navegação e itens de dropdown ao passar o mouse. */
        #appHeader .nav-link:hover, #appHeader .dropdown-item:hover {
            background-color: var(--custom-nav-link-hover-bg);
            color: var(--custom-nav-link-hover-color);
        }
        /* W3C: Estilização para links de navegação ativos. */
        #appHeader .nav-link.active {
            background-color: var(--custom-nav-active-bg);
            color: var(--custom-nav-active-color) !important;
        }
        /* W3C: Estilização para o menu dropdown. */
        #appHeader .dropdown-menu {
            background-color: var(--custom-header-bg);
            border: 1px solid var(--bs-border-color);
        }
        /* W3C: Estilização para itens de dropdown. */
        #appHeader .dropdown-item {
            color: var(--custom-nav-link-color);
        }
        /* W3C: Estilização para o botão do toggler da navbar. */
        #appHeader .navbar-toggler {
            border-color: rgba(var(--bs-primary-rgb), 0.5);
        }
        /* W3C: Ícone do toggler para o tema claro. */
        [data-bs-theme="light"] #appHeader .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='%23db2777' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        /* W3C: Ícone do toggler para o tema escuro. */
        [data-bs-theme="dark"] #appHeader .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='%23ec4899' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        /* W3C: Estilização para o botão de alternar tema. */
        #themeToggle, #themeToggleMobile {
            color: var(--custom-nav-link-color);
        }
        /* W3C: Estilização para o botão de alternar tema ao passar o mouse. */
        #themeToggle:hover, #themeToggleMobile:hover {
             background-color: var(--custom-nav-link-hover-bg) !important;
             color: var(--custom-nav-link-hover-color) !important;
        }

        /* Marcador: Layout - Rodapé */
        /* W3C: Estilização para o rodapé da página. */
        footer {
            background-color: var(--custom-footer-bg);
            color: var(--custom-footer-color);
        }

        /* Marcador: Seções de Conteúdo - Descrição de Técnica */
        /* W3C: Estilização para blocos de texto de descrição de técnica. */
        .technique-description-text {
            margin-bottom: 1rem;
            line-height: 1.6;
            color: var(--bs-body-color);
        }

        /* Marcador: Seções de Conteúdo - Card de Anotação */
        /* W3C: Estilização específica para cards de anotação. */
        .note-card {
            background-color: var(--custom-card-bg);
            border: 1px solid var(--bs-border-color);
            color: var(--custom-card-color);
        }
        /* W3C: Estilização para o título de anotações. */
        .note-card h3 {
            color: var(--custom-text-pink);
            font-size: 1.1rem;
        }
        /* W3C: Estilização para o timestamp das anotações. */
        .note-card .timestamp {
            font-size: 0.75rem;
            color: var(--custom-text-muted-light);
        }
        /* W3C: Estilização para o texto exibido das anotações. */
        .note-card .note-text-display {
            white-space: pre-wrap;
            color: var(--custom-card-color);
        }

        /* Marcador: Seções de Conteúdo - Zona de Emergência */
        /* W3C: Estilização para a seção de zona de emergência. */
        .emergency-zone {
            background-color: var(--custom-emergency-zone-bg);
            border-left: 4px solid var(--custom-emergency-zone-border);
            color: var(--custom-emergency-zone-text);
            padding: 1.5rem;
            border-radius: 0.375rem;
            margin-bottom: 2rem;
        }
        /* W3C: Estilização para o título da zona de emergência. */
        .emergency-zone h2 {
            color: var(--custom-emergency-zone-header);
        }
        /* W3C: Estilização para texto "muted custom" na zona de emergência (tema claro). */
        .emergency-zone .text-muted-custom {
             color: var(--bs-body-color); opacity: 0.8;
        }
        /* W3C: Estilização para texto "muted custom" na zona de emergência (tema escuro). */
        [data-bs-theme="dark"] .emergency-zone .text-muted-custom {
             color: var(--bs-body-color); opacity: 0.7;
        }
        /* W3C: Estilização para listas na zona de emergência. */
        .emergency-zone .list-disc {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        /* W3C: Estilização para o status de emergência. */
        .emergency-status {
             font-size: 0.9rem;
             margin-top: 0.5rem;
        }
        /* W3C: Cores de status de emergência para tema escuro. */
        [data-bs-theme="dark"] .emergency-status { color: #fcd34d; }
        /* W3C: Cores de status de emergência para tema claro. */
        [data-bs-theme="light"] .emergency-status { color: #ca8a04; }

        /* Marcador: Seções de Conteúdo - Página de Autenticação */
        /* W3C: Estilização do contêiner da página de autenticação. */
        #auth-page > div {
            background-color: var(--custom-card-bg);
            color: var(--custom-card-color);
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
        /* W3C: Estilização para o logo na página de autenticação. */
        .auth-page-logo { /* New class for logo on auth page */
            display: block;
            margin-left: auto;
            margin-right: auto;
            max-height: 300px; /* Adjust size as needed */
            width: auto;
            margin-bottom: 1.5rem; /* Equivalent to Bootstrap's mb-4 */
        }
        /* W3C: Estilização para labels de formulário na página de autenticação. */
        #auth-page .form-label {
            color: var(--custom-card-color);
        }
        /* W3C: Estilização para parágrafos na página de autenticação. */
        #auth-page p {
            color: var(--custom-text-muted-light);
        }
        /* W3C: Estilização para links na página de autenticação. */
        #auth-page a {
            color: var(--bs-primary);
        }
        /* W3C: Estilização para links na página de autenticação ao passar o mouse. */
        #auth-page a:hover {
            color: var(--bs-primary-hover);
        }

        /* Marcador: Utilitários de Mídia - Vídeo/Imagem Responsivos */
        /* W3C: Estilização para imagens responsivas em contêineres de vídeo. */
        .aspect-video img {
            width: 100%;
            height: auto;
            object-fit: cover;
            aspect-ratio: 16 / 9;
            background-color: #6c757d;
        }
        /* W3C: Estilização para o contêiner de aspecto de vídeo. */
        .aspect-video {
            border-radius: 0.375rem;
            overflow: hidden;
        }

        /* Marcador: Seções de Conteúdo - Lista de Contatos */
        /* W3C: Estilização para itens da lista de contatos no painel. */
        #contactsList > div {
            background-color: var(--custom-input-bg);
            color: var(--custom-input-color);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid var(--custom-input-border);
        }
        /* W3C: Estilização para o botão de remover contato. */
        #contactsList .remove-contact-btn {
            color: #dc3545;
        }
        /* W3C: Estilização para o botão de remover contato ao passar o mouse. */
        #contactsList .remove-contact-btn:hover {
            color: #bb2d3b;
        }

        /* Marcador: Componentes - Modal */
        /* W3C: Estilização para o conteúdo do modal. */
        .modal-content {
            background-color: var(--custom-modal-content-bg);
            color: var(--custom-modal-content-color);
        }
        /* W3C: Estilização para o cabeçalho do modal. */
        .modal-header {
            border-bottom-color: var(--bs-border-color);
        }
        /* W3C: Estilização para o rodapé do modal. */
        .modal-footer {
            border-top-color: var(--bs-border-color);
        }

        /* Marcador: Componentes - Chatbot Sinais de Alerta */
        .chatbot-container {
            background-color: var(--custom-chat-bg);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
            box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,0.1);
        }
        .chat-messages { /* Estilo genérico para área de mensagens */
            height: 300px; 
            overflow-y: auto; 
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
            background-color: var(--custom-input-bg); 
        }
        .chat-message { /* Estilo genérico para um balão de mensagem */
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-message.user { /* Mensagem do usuário (Sinais de Alerta) */
            background-color: var(--custom-chat-user-msg-bg);
            color: var(--custom-card-color); 
            margin-left: auto; 
            text-align: right;
        }
        .chat-message.bot { /* Mensagem do bot (Sinais de Alerta) */
            background-color: var(--custom-chat-bot-msg-bg);
            color: var(--custom-chat-bot-msg-color); 
            margin-right: auto; 
            text-align: left;
        }
        .chat-message.bot.loading {
            display: flex;
            align-items: center;
        }
        .chat-message.bot.loading .dot-flashing {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: var(--custom-chat-bot-msg-color);
            color: var(--custom-chat-bot-msg-color);
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: .5s;
            margin-right: 5px; 
        }
        .chat-message.bot.loading .dot-flashing::before, .chat-message.bot.loading .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: var(--custom-chat-bot-msg-color);
            color: var(--custom-chat-bot-msg-color);
            animation: dotFlashing 1s infinite alternate;
        }
        .chat-message.bot.loading .dot-flashing::before {
            left: -15px;
            animation-delay: 0s;
        }
        .chat-message.bot.loading .dot-flashing::after {
            left: 15px;
            animation-delay: 1s;
        }
        @keyframes dotFlashing {
            0% { background-color: var(--custom-chat-bot-msg-color); opacity: 0.5; }
            50%, 100% { background-color: var(--custom-chat-bot-msg-color); opacity: 1; }
        }
        .chat-input-group { /* Estilo genérico para grupo de input+botão */
            display: flex;
            gap: 0.5rem; 
        }
        #chatInputWarning { /* Input específico do Chatbot Sinais de Alerta */
            flex-grow: 1; 
            background-color: var(--custom-chat-input-bg);
            color: var(--custom-input-color);
            border-color: var(--custom-input-border);
        }
        #chatInputWarning::placeholder {
            color: var(--custom-input-placeholder);
        }
        #chatInputWarning:focus {
            background-color: var(--custom-chat-input-bg);
            color: var(--custom-input-color);
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
        }
        #sendWarningChatButton { /* Botão específico do Chatbot Sinais de Alerta */
            flex-shrink: 0; 
        }
        #chatbotPostInteractionLinks {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--bs-border-color);
        }

        /* Marcador: Componentes - Chat da Comunidade */
        .community-chat-card { /* Container do chat da comunidade */
             background-color: var(--custom-card-bg);
             border: 1px solid var(--bs-border-color);
             border-radius: 0.5rem;
             padding: 1rem;
        }
        #communityChatMessagesArea { /* Área de exibição das mensagens da comunidade */
            height: 350px;
            overflow-y: auto;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--custom-input-border);
            background-color: var(--custom-input-bg);
            border-radius: 0.375rem;
            display: flex;
            flex-direction: column;
        }
        .community-chat-message-item { /* Um balão de mensagem individual */
            padding: 0.6rem 0.9rem;
            border-radius: 1rem; /* Mais arredondado para efeito balão */
            margin-bottom: 0.75rem;
            max-width: 75%;
            word-wrap: break-word;
            display: flex;
            flex-direction: column;
            line-height: 1.4;
        }
        .community-chat-message-item.sent { /* Mensagem enviada pelo usuário atual */
            background-color: var(--community-chat-sent-bg);
            color: var(--community-chat-sent-color);
            margin-left: auto;
            align-items: flex-end; /* Alinha conteúdo (meta, texto) à direita */
            border-bottom-right-radius: 0.25rem; /* Para dar forma de balão de fala */
        }
        .community-chat-message-item.received { /* Mensagem recebida de outros usuários */
            background-color: var(--community-chat-received-bg);
            color: var(--community-chat-received-color);
            margin-right: auto;
            align-items: flex-start; /* Alinha conteúdo (meta, texto) à esquerda */
            border-bottom-left-radius: 0.25rem; /* Para dar forma de balão de fala */
        }
        .community-chat-message-item .message-meta { /* Informações do remetente e hora */
            font-size: 0.7rem;
            opacity: 0.85;
            margin-bottom: 0.2rem;
            display: flex; /* Para alinhar nome e tempo */
            justify-content: space-between; /* Espalha nome e tempo */
            width: 100%; /* Ocupa toda a largura do balão */
        }
         .community-chat-message-item.sent .message-meta {
            color: rgba(255,255,255,0.8); /* Ajuste de cor para tema escuro no balão enviado */
        }
        [data-bs-theme="light"] .community-chat-message-item.sent .message-meta {
            color: rgba(255,255,255,0.9); /* Ajuste de cor para tema claro no balão enviado */
        }
        .community-chat-message-item.received .message-meta {
            color: var(--custom-text-muted-light);
        }

        .community-chat-message-item .sender-name {
            font-weight: 600; /* Um pouco mais de destaque */
            margin-right: 8px; /* Espaço entre nome e tempo */
        }
        /* .community-chat-message-item .message-timestamp { */
        /*     O timestamp já está no message-meta, não precisa de estilo separado aqui se o flex funcionar */
        /* } */
        .community-chat-message-item .message-text-content { /* Texto da mensagem */
            font-size: 0.9rem;
            text-align: left; /* Garante que o texto dentro do balão sempre comece da esquerda */
            width: 100%;
        }
        #communityChatInput { /* Input específico do Chat da Comunidade */
            flex-grow: 1;
            background-color: var(--custom-input-bg);
            color: var(--custom-input-color);
            border-color: var(--custom-input-border);
        }
        #communityChatInput::placeholder {
            color: var(--custom-input-placeholder);
        }
        #communityChatInput:focus {
            background-color: var(--custom-input-bg);
            color: var(--custom-input-color);
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
        }
        #sendCommunityChatMessageButton { /* Botão específico do Chat da Comunidade */
            flex-shrink: 0;
        }

        /* Marcador: Animações Customizadas */
        @keyframes pulseLogo {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
        .logo-pulse-animation {
            animation: pulseLogo 2.5s infinite ease-in-out;
        }

        @keyframes pulseEmergencyButton {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); /* Cor primária do btn-danger com alfa */
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
            }
        }
        .emergency-button-pulse-animation {
            animation: pulseEmergencyButton 2s infinite;
        }
        /* Garante que a animação de pulso não interfira no estado ativo */
        .btn-danger-active.emergency-button-pulse-animation,
        .btn-danger-active {
            animation: none !important; /* Remove a animação de pulso quando ativo */
        }

    </style>
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.0.1",
    "marked": "https://esm.sh/marked@^15.0.12",
    "@tailwindcss/browser": "https://esm.sh/@tailwindcss/browser@^4.1.7",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react/": "https://esm.sh/react@^19.1.0/",
    "lucide-react": "https://esm.sh/lucide-react@^0.511.0",
    "react": "https://esm.sh/react@^19.1.0",
    "react-dropzone": "https://esm.sh/react-dropzone@^14.3.8",
    "@monaco-editor/react": "https://esm.sh/@monaco-editor/react@^4.7.0",
    "react-markdown": "https://esm.sh/react-markdown@^10.1.0",
    "remark-gfm": "https://esm.sh/remark-gfm@^4.0.1"
  }
}
</script>
</head>
<body>

    <div id="loader" class="loader" style="display: none;" role="status" aria-live="polite">
        <span class="visually-hidden">Carregando...</span>
    </div>

    <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="messageModalTitle">Notificação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p id="messageText"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" id="closeModalButton" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Inserir Nome de Exibição -->
    <div class="modal fade" id="nameInputModal" tabindex="-1" aria-labelledby="nameInputModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nameInputModalLabel">Como gostaria de ser chamada?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="nameInputField" class="form-control" placeholder="Digite seu nome ou apelido" aria-label="Nome de exibição">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="saveNameButton" class="btn btn-primary">Salvar</button>
                </div>
            </div>
        </div>
    </div>


    <header id="appHeader" style="display: none;">
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand navigate-to d-flex align-items-center" href="#" data-page="dashboard-page">
                    <img src="image/logo_krav_maga_site.png" alt="Krav Maga Woman Logo" class="navbar-brand-logo logo-pulse-animation" onerror="this.style.display='none'; this.alt='Logo não pôde ser carregado';">
                </a>
                <button id="themeToggleMobile" class="btn btn-outline-secondary d-lg-none ms-auto me-2" aria-label="Alternar tema">
                    <i class="fas fa-sun"></i>
                </button>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mobileMenu" aria-controls="mobileMenu" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="mobileMenu">
                    <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-center">
                        <li class="nav-item"><a href="#" class="nav-link navigate-to" data-page="dashboard-page">Início</a></li>
                        <li class="nav-item"><a href="#" class="nav-link navigate-to" data-page="tips-page">Dicas</a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Técnicas <i class="fas fa-chevron-down fa-xs ms-1"></i>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a href="#" class="dropdown-item navigate-to" data-page="techniques-white-page">Faixa Branca</a></li>
                                <li><a href="#" class="dropdown-item navigate-to" data-page="techniques-yellow-page">Faixa Amarela</a></li>
                            </ul>
                        </li>
                        <li class="nav-item"><a href="#" class="nav-link navigate-to" data-page="quiz-page">Quiz</a></li>
                        <li class="nav-item"><a href="#" class="nav-link navigate-to" data-page="view-notes-page">Ver Anotações</a></li>
                        <li class="nav-item"><a href="#" class="nav-link navigate-to" data-page="scenarios-page">Cenários</a></li>
                        <li class="nav-item"><a href="#" class="nav-link navigate-to" data-page="references-page">Referências</a></li>
                        <li class="nav-item"><a href="#" class="nav-link navigate-to" data-page="psychology-page">Psicologia</a></li>
                        <li class="nav-item"><a href="#" class="nav-link navigate-to" data-page="warnings-page">Sinais de Alerta</a></li>
                        <li class="nav-item"><a href="#" class="nav-link navigate-to" data-page="support-page">Suporte</a></li>
                        <li class="nav-item"><a href="#" id="logoutButton" class="nav-link">Sair</a></li>
                        <li class="nav-item d-none d-lg-block">
                            <button id="themeToggle" class="btn btn-outline-secondary ms-2" aria-label="Alternar tema">
                                <i class="fas fa-sun"></i>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main id="appContent" class="container mt-4 mb-5">
        <section id="auth-page" class="page-section active align-items-center justify-content-center p-0"> <div class="w-100" style="max-width: 450px;">
                <img src="image/logo_krav_maga_site.png" alt="Krav Maga Woman Logo" class="auth-page-logo img-fluid logo-pulse-animation" onerror="this.style.display='none'; this.alt='Logo não pôde ser carregado';">

                <form id="loginForm" class="mb-3">
                    <div class="mb-3">
                        <label for="loginEmail" class="form-label">Email</label>
                        <input type="email" id="loginEmail" name="loginEmail" required class="form-control" placeholder="seuemail@exemplo.com" autocomplete="email">
                    </div>
                    <div class="mb-3">
                        <label for="loginPassword" class="form-label">Senha</label>
                        <input type="password" id="loginPassword" name="loginPassword" required class="form-control" placeholder="********" autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Entrar</button>
                </form>
                <p class="text-center">
                    Não tem uma conta? <a href="#" id="showRegister" class="fw-medium">Cadastre-se</a>
                </p>

                <form id="registerForm" style="display: none;">
                    <div class="mb-3">
                        <label for="registerEmail" class="form-label">Email</label>
                        <input type="email" id="registerEmail" name="registerEmail" required class="form-control" placeholder="seuemail@exemplo.com" autocomplete="email">
                    </div>
                    <div class="mb-3">
                        <label for="registerPassword" class="form-label">Senha</label>
                        <input type="password" id="registerPassword" name="registerPassword" required class="form-control" placeholder="Crie uma senha forte (mín. 6 caracteres)" autocomplete="new-password">
                    </div>
                    <div class="mb-3">
                        <label for="registerConfirmPassword" class="form-label">Confirmar Senha</label>
                        <input type="password" id="registerConfirmPassword" name="registerConfirmPassword" required class="form-control" placeholder="Confirme sua senha" autocomplete="new-password">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Cadastrar</button>
                </form>
                <p id="switchToLogin" class="text-center" style="display: none;">
                    Já tem uma conta? <a href="#" id="showLogin" class="fw-medium">Faça login</a>
                </p>
            </div>
        </section>

        <section id="dashboard-page" class="page-section">
            <h1 id="dashboardWelcomeMessage" class="mb-3 h2" style="color: var(--bs-primary);">
                Bem-vinda ao Krav Maga Woman<span id="displayNameSpan"></span>!
                <small class="ms-1 fs-6 fw-normal" id="displayNamePromptContainer" style="display: none;">
                    <a href="#" id="displayNamePromptLink" class="text-decoration-none" style="color: var(--bs-secondary); font-size: 0.8em;">(Como gostaria de ser chamada?)</a>
                </small>
            </h1>
            <p class="lead mb-4">Explore os recursos abaixo para fortalecer sua segurança e conhecimento.</p>
            
            <div class="emergency-zone">
                <h2 class="h5 fw-semibold mb-2"><i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>Zona de Emergência</h2>
                <p class="mb-2 small">Em caso de ameaça iminente, pressione o botão abaixo. Sua localização será rastreada e (simuladamente) enviada via WhatsApp/Telegram (usando CallMeBot para teste) aos seus contatos.</p>
                <button id="emergencyButton" class="btn btn-danger btn-lg mb-2 emergency-button-pulse-animation">
                    <i class="fas fa-bell me-2" aria-hidden="true"></i> EMITIR ALERTA
                </button>
                <p id="emergencyStatus" class="emergency-status d-none"></p>
                <p class="text-muted-custom small mt-2">Certifique-se que os serviços de localização estão ativos.</p>
                <div class="text-muted-custom small mt-3" style="opacity: 0.9;">
                    <p><strong>Aviso sobre Notificações (CallMeBot):</strong></p>
                    <ul class="list-disc small">
                        <li>Este app tenta enviar alertas via WhatsApp e Telegram usando o CallMeBot (<strong class="fw-semibold">apenas para fins de teste</strong>).</li>
                        <li>Para **WhatsApp:** Você precisa de uma API key do CallMeBot (para o serviço de texto) e seus contatos devem autorizar o CallMeBot.</li>
                        <li>Para **Telegram:** Seus contatos (com username ex: @usuario) devem ter autorizado o bot `@CallMeBot_txt_bot` no Telegram.</li>
                        <li>O envio real e confiável de SMS/E-mail/WhatsApp para todos os contatos em uma emergência necessitaria de um sistema de <strong class="fw-semibold">backend robusto</strong>, não presente nesta versão.</li>
                        <li>Sua localização é salva no Firebase, permitindo que um futuro backend processe e envie notificações reais.</li>
                    </ul>
                </div>
                <div class="mt-4">
                    <h3 class="h6 fw-semibold mb-2">Adicionar Contatos de Emergência:</h3>
                    <div id="emergencyContactsForm">
                        <div id="contactsList" class="space-y-2 mb-2">
                            </div>
                        <div class="row g-2">
                            <div class="col-sm">
                                <input type="text" id="contactName" placeholder="Nome do Contato" class="form-control form-control-sm" aria-label="Nome do Contato de Emergência">
                            </div>
                            <div class="col-sm">
                                <input type="text" id="contactDetail" placeholder="WhatsApp (ex: 55119...) ou Telegram (@usuario)" class="form-control form-control-sm" aria-label="Contato (WhatsApp ou Telegram @usuario)">
                            </div>
                            <div class="col-sm-auto">
                                <button id="addContactButton" class="btn btn-secondary btn-sm w-100"><i class="fas fa-plus me-2" aria-hidden="true"></i>Adicionar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mt-4">
                <div class="col">
                    <div class="card h-100 navigate-to" data-page="tips-page" role="button" tabindex="0">
                        <div class="card-body">
                            <h2 class="card-title h5"><i class="fas fa-lightbulb me-2" aria-hidden="true"></i>Dicas de Defesa Pessoal</h2>
                            <p class="card-text small text-muted-light">Orientações práticas para diversas situações de risco.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 navigate-to" data-page="techniques-white-page" role="button" tabindex="0">
                        <div class="card-body">
                            <h2 class="card-title h5"><i class="fas fa-user-ninja me-2" aria-hidden="true"></i>Técnicas: Faixa Branca</h2>
                            <p class="card-text small text-muted-light">Vídeos e instruções das técnicas iniciais.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 navigate-to" data-page="techniques-yellow-page" role="button" tabindex="0">
                        <div class="card-body">
                            <h2 class="card-title h5"><i class="fas fa-user-ninja me-2" aria-hidden="true"></i>Técnicas: Faixa Amarela</h2>
                            <p class="card-text small text-muted-light">Técnicas intermediárias, contra-ataques e liberações.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 navigate-to" data-page="quiz-page" role="button" tabindex="0">
                        <div class="card-body">
                            <h2 class="card-title h5"><i class="fas fa-question-circle me-2" aria-hidden="true"></i>Quiz Interativo</h2>
                            <p class="card-text small text-muted-light">Teste seus conhecimentos sobre as técnicas.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 navigate-to" data-page="view-notes-page" role="button" tabindex="0">
                        <div class="card-body">
                            <h2 class="card-title h5"><i class="fas fa-sticky-note me-2" aria-hidden="true"></i>Ver Anotações</h2>
                            <p class="card-text small text-muted-light">Acesse e edite suas anotações de treino.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 navigate-to" data-page="scenarios-page" role="button" tabindex="0">
                        <div class="card-body">
                            <h2 class="card-title h5"><i class="fas fa-tasks me-2" aria-hidden="true"></i>Análise de Cenários</h2>
                            <p class="card-text small text-muted-light">Simulações de situações reais e como aplicar as técnicas.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 navigate-to" data-page="references-page" role="button" tabindex="0">
                        <div class="card-body">
                            <h2 class="card-title h5"><i class="fas fa-book-open me-2" aria-hidden="true"></i>Arquivos de Referência</h2>
                            <p class="card-text small text-muted-light">Materiais complementares sobre Krav Maga e violência de gênero.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 navigate-to" data-page="psychology-page" role="button" tabindex="0">
                        <div class="card-body">
                            <h2 class="card-title h5"><i class="fas fa-brain me-2" aria-hidden="true"></i>Psicologia da Defesa</h2>
                            <p class="card-text small text-muted-light">Controle do medo, tomada de decisões e autocontrole.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 navigate-to" data-page="warnings-page" role="button" tabindex="0">
                        <div class="card-body">
                            <h2 class="card-title h5"><i class="fas fa-flag me-2" aria-hidden="true"></i>Sinais de Alerta</h2>
                            <p class="card-text small text-muted-light">Reconheça comportamentos abusivos e relacionamentos tóxicos.</p>
                        </div>
                    </div>
                </div>
                   <div class="col">
                    <div class="card h-100 navigate-to" data-page="support-page" role="button" tabindex="0">
                        <div class="card-body">
                            <h2 class="card-title h5"><i class="fas fa-hands-helping me-2" aria-hidden="true"></i>Assistência e Suporte</h2>
                            <p class="card-text small text-muted-light">Canais de denúncia e acolhimento no Brasil.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat da Comunidade -->
            <div id="communityChatContainer" class="community-chat-card mt-5 mb-4">
                <div class="card-body p-3">
                    <h2 class="h5 mb-3" style="color: var(--bs-primary);">
                        <i class="fas fa-comments me-2"></i>Espaço KMW
                    </h2>
                    <div id="communityChatMessagesArea" class="mb-3">
                        <!-- As mensagens do chat serão inseridas aqui -->
                        <p class="text-muted-light small p-2 text-center">Carregando mensagens...</p>
                    </div>
                    <div class="chat-input-group">
                        <input type="text" id="communityChatInput" class="form-control" placeholder="Digite sua mensagem..." aria-label="Mensagem do chat da comunidade">
                        <button id="sendCommunityChatMessageButton" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-1"></i> Enviar
                        </button>
                    </div>
                </div>
            </div>

        </section>

        <section id="tips-page" class="page-section container">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold" style="color: var(--bs-primary);">Dicas Estratégicas de Segurança</h1>
        <p class="lead text-muted">A sua maior ferramenta de defesa pessoal é a prevenção. Adote estes hábitos para reduzir os riscos.</p>
    </div>

    <div class="vstack gap-4">
        
        <!-- Em Ambientes Públicos -->
        <div class="card">
            <div class="card-body p-4">
                <h2 class="card-title h5 fw-bold">Em Ambientes Públicos</h2>
                <ul class="list-unstyled technique-description-text">
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Mantenha a cabeça erguida:</strong> Evite o "visual de vítima" (olhar para baixo, distraída com o celular). Uma postura confiante e atenta a torna um alvo menos atraente.</li>
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Use seus sentidos:</strong> Reduza o volume dos fones de ouvido ou use apenas um lado para se manter ciente dos sons ao seu redor.</li>
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Use o ambiente:</strong> Utilize o reflexo de vitrines e vidros de carros para verificar se alguém a está seguindo, sem precisar olhar para trás diretamente.</li>
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Confie na sua intuição:</strong> Se sentir que algo está errado, provavelmente está. Atravesse a rua, entre em uma loja movimentada ou mude seu caminho.</li>
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Varie sua rotina:</strong> Evite fazer exatamente o mesmo trajeto, nos mesmos horários, todos os dias. Pequenas variações dificultam que alguém preveja seus movimentos.</li>
                </ul>
            </div>
        </div>

        <!-- Em Casa -->
        <div class="card">
            <div class="card-body p-4">
                <h2 class="card-title h5 fw-bold">Em Casa</h2>
                <ul class="list-unstyled technique-description-text">
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Verificação em duas etapas:</strong> Antes de abrir a porta, use o olho mágico. Se for um prestador de serviço, peça a credencial e, se ainda tiver dúvidas, ligue para a empresa a fim de confirmar a visita.</li>
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Cuidado com entregas:</strong> Prefira receber suas encomendas na portaria. Se não for possível, encontre o entregador na porta, mas não o convide para entrar.</li>
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Tenha um "quarto seguro":</strong> Defina um cômodo (geralmente um quarto ou banheiro) que possa ser trancado por dentro e mantenha um celular carregado nele. Em caso de invasão, dirija-se para lá, tranque-se e chame a polícia.</li>
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Não anuncie sua ausência:</strong> Evite postar em redes sociais que você está viajando ou que a casa está vazia. Publique as fotos quando retornar.</li>
                </ul>
            </div>
        </div>

        <!-- No Transporte -->
        <div class="card">
            <div class="card-body p-4">
                <h2 class="card-title h5 fw-bold">No Transporte (Público e Privado)</h2>
                <ul class="list-unstyled technique-description-text">
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>No seu carro:</strong> Mantenha as portas travadas e os vidros altos em semáforos ou no trânsito lento. Deixe distância do carro da frente para ter uma rota de fuga.</li>
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Em transporte público:</strong> Evite vagões ou assentos isolados. Posicione sua bolsa ou mochila na sua frente, junto ao corpo.</li>
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Em aplicativos de transporte:</strong> Sempre confira a placa, o modelo do carro e o nome do motorista. Compartilhe sua rota com um contato de confiança. Sente-se sempre no banco de trás, do lado oposto ao do motorista, para ter acesso a duas saídas.</li>
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Ao desembarcar:</strong> Tenha as chaves de casa na mão, prontas para uso. Observe o ambiente antes de sair do carro ou do ponto de ônibus.</li>
                </ul>
            </div>
        </div>
        
        <!-- Vida Digital e Social -->
        <div class="card">
            <div class="card-body p-4">
                <h2 class="card-title h5 fw-bold">Vida Digital e Social</h2>
                <ul class="list-unstyled technique-description-text">
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Proteja sua privacidade:</strong> Configure suas redes sociais como privadas. Tenha cuidado com quem você adiciona e com a quantidade de informações pessoais que compartilha.</li>
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Segurança em encontros:</strong> Ao conhecer alguém pela internet, os primeiros encontros devem ser em locais públicos e movimentados. Sempre avise um amigo ou familiar sobre onde e com quem você estará.</li>
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Cuidado com a geolocalização:</strong> Evite postar fotos ou stories que revelem sua localização exata em tempo real. Desative a marcação de localização automática das fotos no seu celular.</li>
                    <li class="mb-2"><i class="fas fa-check-circle fa-xs me-2"></i><strong>Desconfie de pedidos incomuns:</strong> Tenha cuidado com pedidos de dinheiro, fotos íntimas ou informações muito pessoais de contatos online, mesmo que pareçam conhecidos (o perfil pode ter sido clonado).</li>
                </ul>
            </div>
        </div>

    </div>
</section>

 <section id="techniques-white-page" class="page-section">
            <h1 class="h2 mb-4" style="color: var(--bs-primary);">Técnicas – Faixa Branca</h1>
            <div id="techniquesWhiteList" class="vstack gap-5">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title h5 mb-3">Técnica 1: Postura de Combate e Movimentação</h2>
                        <div class="aspect-video mb-3">
                            <iframe style="aspect-ratio: 16 / 9; width: 100%; height: auto;"
                                    src="https://www.youtube.com/embed/VIDEO_ID_POSTURA_BASICA"
                                    title="Vídeo da Técnica 1: Postura de Combate e Movimentação"
                                    frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                    referrerpolicy="strict-origin-when-cross-origin"
                                    allowfullscreen></iframe>
                        </div>
                        <p class="technique-description-text">A postura de combate (ou guarda) é a base para todas as técnicas de defesa e ataque. Mantenha os pés afastados na largura dos ombros, um pé ligeiramente à frente do outro (pé dominante atrás para destros). Joelhos levemente flexionados para absorver impacto e permitir movimentação rápida. O peso do corpo deve estar equilibrado entre as pernas. Mãos levantadas protegendo o rosto e o tronco, cotovelos próximos ao corpo. Olhar focado no agressor, mas com consciência do ambiente (visão periférica). A movimentação deve ser fluida, sem cruzar as pernas, mantendo sempre a base e a guarda.</p>
                        <div>
                            <label for="notes-technique-white-1" class="form-label small">Suas Anotações:</label>
                            <textarea id="notes-technique-white-1" data-technique-id="white_001" rows="3" class="form-control form-control-sm notes-area" placeholder="Ex: Lembrar de manter o queixo baixo..."></textarea>
                            <button class="btn btn-sm btn-secondary mt-2 save-note-button" data-technique-id="white_001"><i class="fas fa-save me-2" aria-hidden="true"></i>Salvar Anotação</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title h5 mb-3">Técnica 2: Soco Direto (Jab e Direto)</h2>
                        <div class="aspect-video mb-3">
                           <iframe style="aspect-ratio: 16 / 9; width: 100%; height: auto;"
                                   src="https://www.youtube.com/embed/VIDEO_ID_SOCO_DIRETO"
                                   title="Vídeo da Técnica 2: Soco Direto (Jab e Direto)"
                                   frameborder="0"
                                   allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                   referrerpolicy="strict-origin-when-cross-origin"
                                   allowfullscreen></iframe>
                        </div>
                        <p class="technique-description-text">O soco direto é um dos golpes mais rápidos e eficientes. O Jab é desferido com a mão da frente, visando distrair ou medir a distância. O Direto é desferido com a mão de trás, com maior potência, utilizando a rotação do quadril e do ombro. Em ambos, o punho deve girar no momento do impacto (posição horizontal), e o braço deve retornar rapidamente à posição de guarda. Mantenha o cotovelo próximo ao corpo durante a trajetória do soco para proteção.</p>
                        <div>
                            <label for="notes-technique-white-2" class="form-label small">Suas Anotações:</label>
                            <textarea id="notes-technique-white-2" data-technique-id="white_002" rows="3" class="form-control form-control-sm notes-area" placeholder="Ex: Focar na rotação do quadril para o direto..."></textarea>
                            <button class="btn btn-sm btn-secondary mt-2 save-note-button" data-technique-id="white_002"><i class="fas fa-save me-2" aria-hidden="true"></i>Salvar Anotação</button>
                        </div>
                    </div>
                </div>
                   <div class="card">
                    <div class="card-body">
                        <h2 class="card-title h5 mb-3">Técnica 3: Defesa Simples de Soco Direto (Bloqueio 360 Externo)</h2>
                        <div class="aspect-video mb-3">
                            <iframe style="aspect-ratio: 16 / 9; width: 100%; height: auto;"
                                    src="https://www.youtube.com/embed/VIDEO_ID_DEFESA_360"
                                    title="Vídeo da Técnica 3: Defesa Simples de Soco Direto (Bloqueio 360 Externo)"
                                    frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                    referrerpolicy="strict-origin-when-cross-origin"
                                    allowfullscreen></iframe>
                        </div>
                        <p class="technique-description-text">Contra um soco direto vindo em direção ao rosto, utilize o antebraço para desviar o golpe para fora da linha do seu corpo. Se o soco vier da direita do agressor (seu lado esquerdo), use seu braço esquerdo. O movimento é circular, partindo da guarda, subindo e empurrando o braço do agressor para o seu lado externo. Mantenha a outra mão em guarda. O movimento deve ser acompanhado de um pequeno passo lateral ou para trás para sair da linha de ataque e criar ângulo para um contra-ataque imediato.</p>
                        <div>
                            <label for="notes-technique-white-3" class="form-label small">Suas Anotações:</label>
                            <textarea id="notes-technique-white-3" data-technique-id="white_003" rows="3" class="form-control form-control-sm notes-area" placeholder="Ex: Praticar o timing do bloqueio e contra-ataque..."></textarea>
                            <button class="btn btn-sm btn-secondary mt-2 save-note-button" data-technique-id="white_003"><i class="fas fa-save me-2" aria-hidden="true"></i>Salvar Anotação</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="techniques-yellow-page" class="page-section">
            <h1 class="h2 mb-4" style="color: var(--bs-primary);">Técnicas – Faixa Amarela</h1>
            <div id="techniquesYellowList" class="vstack gap-5">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title h5 mb-3">Técnica 1: Liberação de Agarrão de Pulso (Mesmo Lado)</h2>
                        <div class="aspect-video mb-3">
                            <iframe style="aspect-ratio: 16 / 9; width: 100%; height: auto;"
                                    src="https://www.youtube.com/embed/VIDEO_ID_LIBERACAO_PULSO"
                                    title="Vídeo da Técnica 1: Liberação de Agarrão de Pulso (Mesmo Lado)"
                                    frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                    referrerpolicy="strict-origin-when-cross-origin"
                                    allowfullscreen></iframe>
                        </div>
                        <p class="technique-description-text">Se o agressor segurar seu pulso com a mão do mesmo lado (ex: mão direita dele no seu pulso direito), o ponto fraco da pegada é entre o polegar e os outros dedos dele. Gire seu pulso vigorosamente na direção do polegar do agressor, puxando seu braço em um movimento circular e explosivo para cima e para fora. Simultaneamente, dê um passo para trás com a perna do mesmo lado para criar distância e desequilibrar o agressor. Esteja pronta para um contra-ataque imediato (chute, soco com a mão livre).</p>
                        <div>
                            <label for="notes-technique-yellow-1" class="form-label small">Suas Anotações:</label>
                            <textarea id="notes-technique-yellow-1" data-technique-id="yellow_001" rows="3" class="form-control form-control-sm notes-area" placeholder="Ex: Lembrar da explosão no movimento..."></textarea>
                            <button class="btn btn-sm btn-secondary mt-2 save-note-button" data-technique-id="yellow_001"><i class="fas fa-save me-2" aria-hidden="true"></i>Salvar Anotação</button>
                        </div>
                    </div>
                </div>
                <div class="col"> <div class="card h-100">
                        <div class="card-body">
                            <h2 class="card-title h5 mb-3">Técnica 2: Chute Frontal (Pisão - Reto)</h2>
                            <div class="aspect-video mb-3">
                                 <iframe style="aspect-ratio: 16 / 9; width: 100%; height: auto;"
                                         src="https://www.youtube.com/embed/VIDEO_ID_CHUTE_FRONTAL"
                                         title="Vídeo da Técnica 2: Chute Frontal (Pisão - Reto)"
                                         frameborder="0"
                                         allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                         referrerpolicy="strict-origin-when-cross-origin"
                                         allowfullscreen></iframe>
                            </div>
                            <p class="technique-description-text">O chute frontal (pisão) é um golpe potente para manter distância ou atingir pontos baixos do agressor (joelho, canela, virilha). A partir da postura de combate, levante o joelho da perna de trás (ou da frente, para um chute mais rápido e curto) em direção ao peito. Estenda a perna rapidamente para frente, atingindo o alvo com a sola do pé (calcanhar ou planta do pé). O quadril acompanha o movimento para gerar mais força. Retraia a perna rapidamente para a posição inicial ou para uma nova base. Mantenha a guarda alta durante todo o movimento.</p>
                            <div>
                                <label for="notes-technique-yellow-2" class="form-label small">Suas Anotações:</label>
                                <textarea id="notes-technique-yellow-2" data-technique-id="yellow_002" rows="3" class="form-control form-control-sm notes-area" placeholder="Ex: Focar no uso do quadril e retorno rápido..."></textarea>
                                <button class="btn btn-sm btn-secondary mt-2 save-note-button" data-technique-id="yellow_002"><i class="fas fa-save me-2" aria-hidden="true"></i>Salvar Anotação</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-notes-page" class="page-section">
            <h1 class="h2 mb-4" style="color: var(--bs-primary);">Minhas Anotações</h1>

            <div class="mb-5">
                <h2 class="h4 mb-3" style="color: var(--bs-primary-hover);">Anotações da Faixa Branca</h2>
                <div id="whiteBeltNotesContainer" class="vstack gap-3">
                    <p class="text-muted-light">Nenhuma anotação para a Faixa Branca ainda.</p>
                </div>
            </div>

            <div>
                <h2 class="h4 mb-3" style="color: var(--bs-primary-hover);">Anotações da Faixa Amarela</h2>
                <div id="yellowBeltNotesContainer" class="vstack gap-3">
                    <p class="text-muted-light">Nenhuma anotação para a Faixa Amarela ainda.</p>
                </div>
            </div>
        </section>

        <section id="quiz-page" class="page-section">
            <h1 class="h2 mb-4" style="color: var(--bs-primary);">Quiz Interativo</h1>
            <div id="quizContainer" class="card">
                <div class="card-body">
                    <p class="text-muted-light">Carregando quiz...</p>
                </div>
            </div>
            <div id="quizResult" class="card mt-4" style="display:none;">
                <div class="card-body">
                    <h2 class="card-title h5">Resultado do Quiz:</h2>
                    <p id="quizScore" class="lead"></p>
                    <button id="retakeQuizButton" class="btn btn-primary mt-3">Tentar Novamente</button>
                </div>
            </div>
        </section>

                <section id="scenarios-page" class="page-section container">
                <div class="text-center mb-5">
                    <h1 class="display-5 fw-bold" style="color: var(--bs-primary);">Análise de Cenários</h1>
                    <p class="lead text-muted">Aprenda a identificar, prevenir e reagir a ameaças comuns. A melhor luta é aquela que se evita.</p>
                </div>

                <div class="vstack gap-4">

                    <!-- Cenário 1: Tentativa de Assalto na Rua -->
                    <div class="card">
                        <div class="card-body p-4">
                            <h2 class="card-title h5 fw-bold">Cenário 1: Tentativa de Assalto na Rua</h2>
                            <p class="technique-description-text">Você está caminhando em uma rua pouco movimentada. Um indivíduo se aproxima e anuncia um assalto, exigindo seus pertences. Ele não exibe uma arma claramente, mas age de forma intimidatória.</p>
                            
                            <h3 class="h6 fw-semibold mt-4" style="color: var(--bs-primary);">Plano de Ação Tático:</h3>
                            <ul class="list-unstyled technique-description-text">
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Mantenha a Calma e a Distância:</strong> Respire fundo. Levante as mãos abertas na altura do peito, em um gesto de "calma, não quero problemas". Isso te acalma, mostra ao agressor que você não é uma ameaça e prepara suas mãos para uma defesa rápida (essa posição é chamada de "fence" ou "escudo").</li>
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Obedeça, mas com Controle:</strong> Informe seus movimentos. Diga: "Ok, vou pegar a carteira/celular". Entregue os objetos. Sua vida vale mais. Se possível, jogue os objetos um pouco para o lado, forçando o agressor a desviar a atenção e te dando uma fração de segundo para se afastar.</li>
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Análise Contínua do Ambiente:</strong> Sem encarar, escaneie o ambiente. Observe as mãos do agressor, a presença de cúmplices e rotas de fuga (uma loja, uma esquina movimentada). Memorize características do agressor (roupas, altura, voz).</li>
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Crie uma Janela de Fuga:</strong> Assim que o agressor estiver focado nos objetos, afaste-se com passos largos para trás, mantendo a visão periférica nele. Não dê as costas imediatamente. Corra para um local seguro assim que houver distância suficiente e chame a polícia (190).</li>
                            </ul>

                            <h4 class="h6 fw-semibold mt-3" style="color: #dc3545;">Ponto de Alerta: E se a situação escalar?</h4>
                            <p class="technique-description-text small">Se o agressor tentar te agarrar, a situação muda de roubo para agressão física. A resposta deve ser explosiva e focada em criar uma oportunidade para escapar. Utilize as ferramentas mais simples e eficazes do Krav Maga: ataque aos pontos vulneráveis (olhos, garganta, genitais) e fuja na primeira oportunidade. A reação física é o último recurso, usado apenas para preservar sua integridade física.</p>
                        </div>
                    </div>

                    <!-- Cenário 2: Abordagem Indesejada em Transporte Público -->
                    <div class="card">
                        <div class="card-body p-4">
                            <h2 class="card-title h5 fw-bold">Cenário 2: Assédio em Transporte Público</h2>
                            <p class="technique-description-text">Você está em um ônibus ou metrô e um passageiro começa a te assediar verbalmente e a invadir seu espaço pessoal, talvez com toques indesejados.</p>
                            
                            <h3 class="h6 fw-semibold mt-4" style="color: var(--bs-primary);">Plano de Ação Tático:</h3>
                            <ul class="list-unstyled technique-description-text">
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Crie uma Barreira e Use a Voz:</strong> Use sua bolsa ou mochila como um escudo entre você e a pessoa. Olhe diretamente para ela e diga em voz alta, clara e firme: "NÃO TOQUE EM MIM" ou "AFASTE-SE". A firmeza e o volume alto servem tanto para o agressor quanto para alertar os outros passageiros.</li>
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Mude de Posição Estratégica:</strong> Levante-se e procure um local mais seguro: perto do motorista, de um grupo de mulheres, de uma câmera de segurança ou da porta de saída. Mover-se quebra o padrão do agressor e te coloca em vantagem.</li>
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Exponha o Agressor:</strong> Se o comportamento continuar, não hesite em chamar atenção de forma explícita. "SOCORRO! ESTE HOMEM ESTÁ ME ASSediando!". A vergonha pública é uma ferramenta poderosa contra agressores que contam com o silêncio da vítima.</li>
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Prepare-se para Agir:</strong> Se a ameaça se tornar física, esteja pronta para se defender. Use o ambiente a seu favor: apoie-se nas barras para ter estabilidade e use golpes curtos e eficazes, como cotoveladas e joelhadas.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Cenário 3: Confronto em Espaço Confinado (Elevador) -->
                    <div class="card">
                        <div class="card-body p-4">
                            <h2 class="card-title h5 fw-bold">Cenário 3: Confronto em Espaço Confinado (Elevador)</h2>
                            <p class="technique-description-text">Você entra em um elevador e outro indivíduo entra em seguida, adotando um comportamento ameaçador ou bloqueando seu acesso aos botões e à porta.</p>
                            
                            <h3 class="h6 fw-semibold mt-4" style="color: var(--bs-primary);">Plano de Ação Tático:</h3>
                            <ul class="list-unstyled technique-description-text">
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Posicionamento Imediato:</strong> Ao entrar, posicione-se sempre ao lado do painel de controle. Isso lhe dá acesso imediato aos botões de andar e ao alarme.</li>
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Confie na Intuição:</strong> Se alguém entrar e você se sentir desconfortável, saia do elevador antes que a porta se feche. Diga "Esqueci algo" e saia. É melhor parecer excessivamente cautelosa do que ficar em uma armadilha.</li>
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Ação de Emergência:</strong> Se a ameaça se confirmar dentro do elevador, pressione o botão de alarme e TODOS os botões de andar. Isso fará com que o elevador pare em todos os andares, aumentando suas chances de fuga ou de alguém ver o que está acontecendo.</li>
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Defesa em Curta Distância:</strong> Se a agressão for inevitável, use a parede do elevador para se apoiar e gerar força. Golpes curtos como cotoveladas, cabeçadas, joelhadas e pisões no pé são extremamente eficazes em espaços confinados. Grite o mais alto que puder durante a defesa para chamar atenção.</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Cenário 4: Ameaça em Estacionamento -->
                    <div class="card">
                        <div class="card-body p-4">
                            <h2 class="card-title h5 fw-bold">Cenário 4: Ameaça em Estacionamento</h2>
                            <p class="technique-description-text">Ao se dirigir ao seu carro em um estacionamento, você percebe alguém te seguindo ou um indivíduo suspeito perto do seu veículo, bloqueando seu acesso.</p>
                            
                            <h3 class="h6 fw-semibold mt-4" style="color: var(--bs-primary);">Plano de Ação Tático:</h3>
                            <ul class="list-unstyled technique-description-text">
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Prevenção e Alerta:</strong> Aproxime-se do seu carro com as chaves na mão, prontas para uso. Mantenha a cabeça erguida e escaneie todo o ambiente: olhe entre os carros, para trás e para os lados. Ande com propósito e confiança.</li>
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Mude o Rumo:</strong> Se notar alguém suspeito ou se sua intuição apitar, não continue até o carro. Mude de direção imediatamente e volte para um local público e bem iluminado (shopping, loja, guarita do segurança). Ligue para a segurança do local ou para a polícia.</li>
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>Use o Alarme como Ferramenta:</strong> Se a ameaça se aproximar rapidamente, aperte o botão de pânico do alarme do seu carro. O barulho alto e súbito atrai atenção e pode assustar o agressor o suficiente para que ele desista.</li>
                                <li class="mb-2"><i class="fas fa-angle-right fa-xs me-2 opacity-75"></i><strong>O Carro como Escudo:</strong> Se você já está ao lado do carro quando a ameaça surge, use-o como uma barreira. Mantenha o veículo entre você e o agressor enquanto se afasta e grita por ajuda. A porta aberta do carro também pode ser usada como um escudo ou empurrada contra o agressor para criar espaço.</li>
                            </ul>
                        </div>
                    </div>

                </div>
            </section>

            <section id="references-page" class="page-section">
                <h1 class="h2 mb-4" style="color: var(--bs-primary);">Arquivos de Referência</h1>
                <div class="vstack gap-4">

                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title h5">Estudo: Impacto Psicológico da Violência de Gênero</h2>
                            <p class="technique-description-text">Análise sobre as consequências psicológicas da violência de gênero na vida das mulheres, abordando temas como transtorno de estresse pós-traumático (TEPT), depressão, ansiedade e a importância de redes de apoio e acompanhamento psicológico.</p>
                            <a href="https://www.ipea.gov.br/portal/images/stories/PDFs/SIPS/sips_violencia_contra_mulheres.pdf" target="_blank" rel="noopener noreferrer" class="btn btn-link btn-sm p-0" style="color: var(--bs-primary);">Ver estudo do IPEA (PDF) <i class="fas fa-external-link-alt fa-xs ms-1"></i></a>
                        </div>
                    </div>
                    
                    <!-- Novos Materiais sobre Krav Maga -->
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title h5">Artigo: A História e Filosofia do Krav Maga</h2>
                            <p class="technique-description-text">Um olhar aprofundado sobre as origens do Krav Maga com Imi Lichtenfeld em Israel na década de 1940. Sua evolução de um sistema de combate militar para uma técnica de autodefesa civil e os princípios que o norteiam: simplicidade, eficácia e o uso de reações instintivas para a sobrevivência.</p>
                            <a href="https://kravmaga.com.br/historia/" target="_blank" rel="noopener noreferrer" class="btn btn-link btn-sm p-0" style="color: var(--bs-primary);">Ler mais na Fed. Sul Americana de Krav Maga <i class="fas fa-external-link-alt fa-xs ms-1"></i></a>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title h5">Artigo Acadêmico: Concepções e Controvérsias do Krav Maga (PDF)</h2>
                            <p class="technique-description-text">Uma análise acadêmica sobre as diferentes concepções, controvérsias e reflexões a respeito do Krav Maga. O artigo discute sua classificação como luta ou arte marcial e sua evolução, oferecendo uma perspectiva crítica e aprofundada sobre o tema.</p>
                            <a href="https://ojs.brazilianjournals.com.br/ojs/index.php/BRJD/article/download/38976/pdf/97747" target="_blank" rel="noopener noreferrer" class="btn btn-link btn-sm p-0" style="color: var(--bs-primary);">Acessar artigo acadêmico em PDF <i class="fas fa-external-link-alt fa-xs ms-1"></i></a>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title h5">Artigo Acadêmico: Repensando a História do Krav Maga no Brasil (PDF)</h2>
                            <p class="technique-description-text">Este estudo oferece uma visão sobre a história do Krav Maga no Brasil, analisando as narrativas e representações da modalidade no país. Ideal para quem busca compreender o contexto sociocultural e a expansão da arte marcial em território brasileiro.</p>
                            <a href="https://ojs.brazilianjournals.com.br/ojs/index.php/BJHR/article/download/57311/41937/138918" target="_blank" rel="noopener noreferrer" class="btn btn-link btn-sm p-0" style="color: var(--bs-primary);">Acessar estudo em PDF <i class="fas fa-external-link-alt fa-xs ms-1"></i></a>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title h5">Manual de Defesa Pessoal para Profissionais (PDF)</h2>
                            <p class="technique-description-text">Um manual abrangente com conceitos e técnicas de defesa pessoal, abordando vertentes como a militar/policial e a urbana. Explica princípios táticos, níveis de ameaça e o uso de força proporcional, oferecendo uma base sólida sobre segurança pessoal.</p>
                            <a href="https://systemamartialart.pt/wp-content/uploads/2023/06/systema_defesapessoal.pdf" target="_blank" rel="noopener noreferrer" class="btn btn-link btn-sm p-0" style="color: var(--bs-primary);">Baixar Manual de Defesa Pessoal <i class="fas fa-external-link-alt fa-xs ms-1"></i></a>
                        </div>
                    </div>
                </div>
            </section>

            <section id="psychology-page" class="page-section">
                <h1 class="h2 mb-4" style="color: var(--bs-primary);">Psicologia da Defesa Pessoal</h1>
                <article class="card">
                    <div class="card-body">
                        <h2 class="card-title h5 mb-3">Controle do Medo e Ansiedade</h2>
                        <p class="technique-description-text">O medo é uma resposta inevitável e essencial à percepção de perigo. O objetivo no Krav Maga não é eliminá-lo, mas sim canalizá-lo para um "medo funcional". Sob estresse, o corpo libera adrenalina, causando reações como visão de túnel, exclusão auditória e perda de habilidades motoras finas. O treinamento combate isso através de:
                            <br>• <strong>Técnicas de respiração tática:</strong> Respirações profundas e controladas para diminuir a frequência cardíaca e oxigenar o cérebro, permitindo maior clareza mental.
                            <br>• <strong>Simulação de estresse:</strong> Treinar sob cansaço, com múltiplos agressores ou em cenários caóticos acostuma o corpo e a mente a operar sob pressão, transformando o pânico paralisante em um estado de alerta elevado e focado.
                        </p>

                        <h2 class="card-title h5 my-3">Tomada de Decisões Sob Pressão</h2>
                        <p class="technique-description-text">Em uma situação de confronto, não há tempo para deliberação. A capacidade de tomar decisões rápidas e eficazes é crucial. O estresse degrada a cognição complexa, por isso o treinamento se concentra em:
                            <br>• <strong>Princípios, não apenas técnicas:</strong> O Krav Maga ensina princípios universais (ex: ir da defesa ao ataque o mais rápido possível, atacar pontos vulneráveis) que se aplicam a inúmeras situações, simplificando a escolha da reação.
                            <br>• <strong>Automatização de respostas:</strong> A repetição exaustiva em cenários variados cria "caminhos neurais" que tornam a resposta defensiva quase instintiva, contornando a análise consciente lenta e permitindo que você reaja de forma eficaz mesmo antes de processar completamente a ameaça. Reconhecer padrões de agressão (gatilhos) é fundamental para antecipar e agir preventivamente.
                        </p>

                        <h2 class="card-title h5 my-3">Autocontrole Emocional e Mentalidade de Sobrevivência</h2>
                        <p class="technique-description-text">Sua mentalidade é sua arma mais importante. A "mentalidade de sobrevivência" ou "survival mindset" é a recusa absoluta em ser uma vítima. Isso significa:
                            <br>• <strong>Ligar o "interruptor":</strong> É a capacidade mental de passar instantaneamente de um estado normal para um nível de agressividade focado e determinado, fazendo o que for necessário para se proteger.
                            <br>• <strong>Foco no objetivo:</strong> Em meio ao caos, o único objetivo é sobreviver e chegar em casa em segurança. Isso significa não se prender à dor ou ao medo, mas focar em criar uma janela de fuga.
                            <br>• <strong>Resiliência:</strong> É a capacidade de continuar lutando mesmo quando ferido, cansado ou em desvantagem numérica. É a determinação que surpreende o agressor, que espera uma vítima passiva.
                        </p>

                        <h2 class="card-title h5 my-3">Agressividade Controlada e Assertividade</h2>
                        <p class="technique-description-text">É vital diferenciar os dois conceitos:
                            <br>• <strong>Assertividade (Prevenção):</strong> É a sua primeira linha de defesa. Manifesta-se através da comunicação verbal e não verbal para evitar que uma situação se torne violenta. Inclui manter uma postura ereta, fazer contato visual firme, usar um tom de voz claro e impor limites ("Afaste-se", "Não me siga"). A assertividade projeta confiança e sinaliza que você não é um alvo fácil.
                            <br>• <strong>Agressividade Controlada (Ação):</strong> Esta não é raiva, é uma ferramenta tática. Quando a agressão física é inevitável, a resposta deve ser uma explosão de violência avassaladora, focada e contínua, com o único propósito de neutralizar a ameaça imediata para criar uma oportunidade segura de escapar. É um ato consciente e deliberado para sobrepujar o agressor e garantir sua sobrevivência.
                        </p>
                    </div>
                </article>
            </section>

            <section id="warnings-page" class="page-section">
                <h1 class="h2 mb-4" style="color: var(--bs-primary);">Sinais de Alerta em Relacionamentos</h1>
                <!--<div class="card">
                    <div class="card-body">
                        <p class="technique-description-text mb-3">Reconhecer comportamentos abusivos é o primeiro passo para se proteger. Fique atenta a:</p>
                        <ul class="list-unstyled technique-description-text">
                            <li class="mb-2"><i class="fas fa-exclamation-triangle text-warning me-2"></i><strong>Controle Excessivo:</strong> Tenta controlar suas roupas, amizades, finanças, aonde você vai, com quem fala. Exige senhas de redes sociais ou celular.</li>
                            <li class="mb-2"><i class="fas fa-exclamation-triangle text-warning me-2"></i><strong>Isolamento:</strong> Afasta você de amigos e familiares, critica suas relações e cria conflitos para que você se afaste de sua rede de apoio.</li>
                            <li class="mb-2"><i class="fas fa-exclamation-triangle text-warning me-2"></i><strong>Ciúme Patológico:</strong> Demonstra ciúme desproporcional e acusações infundadas de traição. Monitora seus passos e questiona suas atividades constantemente.</li>
                            <li class="mb-2"><i class="fas fa-exclamation-triangle text-warning me-2"></i><strong>Críticas Constantes e Desvalorização:</strong> Humilhações (privadas ou públicas), desvaloriza suas opiniões, aparência, inteligência ou conquistas. Faz você se sentir inadequada ou culpada por tudo.</li>
                            <li class="mb-2"><i class="fas fa-exclamation-triangle text-warning me-2"></i><strong>Manipulação Emocional (Gaslighting):</strong> Distorce a realidade para fazer você duvidar de sua própria sanidade ou percepção dos fatos. Nega eventos que aconteceram ou inventa situações.</li>
                            <li class="mb-2"><i class="fas fa-exclamation-triangle text-warning me-2"></i><strong>Explosões de Raiva e Intimidação:</strong> Mudanças repentinas de humor, gritos, xingamentos, quebrar objetos, ameaças veladas ou diretas (a você, seus filhos, animais de estimação), olhares intimidadores, gestos agressivos.</li>
                            <li class="mb-2"><i class="fas fa-exclamation-triangle text-warning me-2"></i><strong>Responsabilização da Vítima:</strong> Culpa você pelos problemas do relacionamento ou pelo comportamento abusivo dele(a). ("Você me provocou", "Se você não fizesse X, eu não faria Y").</li>
                            <li class="mb-2"><i class="fas fa-exclamation-triangle text-warning me-2"></i><strong>Pressão para Atividades Sexuais:</strong> Ignora seus desejos e limites em relação à intimidade, força ou coage a atos sexuais contra sua vontade.</li>
                        </ul>
                        <p class="mt-3 technique-description-text">Se você identifica algum desses sinais, procure ajuda. Você não está sozinha. Converse com pessoas de confiança e busque apoio especializado.</p>
                    </div>
                    </div>
                -->

                <div class="chatbot-container mt-4">
                    <h3 class="h5 mb-3" style="color: var(--custom-text-pink);">Converse com nossa Analista Virtual</h3>
                    <p class="small text-muted-light mb-3">Descreva situações ou sentimentos que você está vivenciando em seu relacionamento. Nossa analista virtual, baseada nos sinais de alerta listados acima, tentará ajudar a identificar possíveis comportamentos abusivos. Lembre-se, esta é uma ferramenta de apoio inicial e não substitui o aconselhamento profissional.</p>
                    <div id="chatMessagesWarning" class="chat-messages">
                    </div>
                    <div class="chat-input-group mt-3">
                        <input type="text" id="chatInputWarning" class="form-control" placeholder="Digite sua mensagem aqui...">
                        <button id="sendWarningChatButton" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Enviar
                        </button>
                    </div>
                    <div id="chatbotPostInteractionLinks" style="display: none;" class="mt-3 pt-3 border-top">
                        <p class="small text-muted-light mb-2">Para saber mais sobre os Sinais de Alerta ou encontrar canais de Apoio e Assistência, acesse:</p>
                        <!--<button class="btn btn-sm btn-outline-primary navigate-to mb-2 w-100" data-page="warnings-page">
                            <i class="fas fa-flag me-2"></i>Ver Sinais de Alerta Detalhados
                        </button>
                        -->
                        <button class="btn btn-sm btn-primary navigate-to w-100" data-page="support-page">
                            <i class="fas fa-hands-helping me-2"></i>Encontrar Canais de Suporte
                        </button>
                    </div>
                </div>
            </section>

        <section id="support-page" class="page-section">
            <h1 class="h2 mb-4" style="color: var(--bs-primary);">Assistência e Suporte à Mulher</h1>
            <p class="lead mb-4">Conheça os principais canais de denúncia, acolhimento e apoio disponíveis no Brasil.</p>

            <div class="mb-3">
                <button id="findSupportNearMeButton" class="btn btn-primary w-100 mb-4 py-2">
                    <i class="fas fa-map-marker-alt me-2"></i>Encontrar Ajuda Perto de Mim (DEAMs e Centros de Referência)
                </button>
            </div>
        
            <!-- Categoria: Denúncia e Emergência -->
            <h2 class="h4 mb-3 mt-4" style="color: var(--bs-primary-hover);">Denúncia e Emergência</h2>
            <div class="row row-cols-1 row-cols-md-2 g-4">
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="card-title h5">
                                <i class="fas fa-phone-square-alt me-2" aria-hidden="true"></i>
                                <a href="tel:190" class="text-decoration-none" style="color: inherit;">Ligue 190 – Polícia Militar</a>
                            </h3>
                            <p class="technique-description-text small">Para emergências imediatas, risco à vida ou flagrante delito. Clique no número para ligar.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="card-title h5">
                                <i class="fas fa-phone-alt me-2" aria-hidden="true"></i>
                                <a href="tel:180" class="text-decoration-none" style="color: inherit;">Ligue 180 – Central de Atendimento à Mulher</a>
                            </h3>
                            <p class="technique-description-text small">Clique no número para ligar. Serviço nacional, gratuito e confidencial que oferece escuta e orientação qualificada. Funciona 24 horas.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="card-title h5"><i class="fas fa-landmark me-2" aria-hidden="true"></i>Delegacia da Mulher (DEAM)</h3>
                            <p class="technique-description-text small">Procure a Delegacia Especializada de Atendimento à Mulher mais próxima. Em alguns estados, é possível registrar Boletim de Ocorrência online.</p>
                            <a href="https://www.gov.br/mj/pt-br/assuntos/sua-seguranca/violencia-contra-a-mulher/delegacias-da-mulher" target="_blank" rel="noopener noreferrer" class="btn btn-link btn-sm p-0" style="color: var(--bs-primary);">Encontrar DEAMs (Nacional) <i class="fas fa-external-link-alt fa-xs ms-1"></i></a>
                        </div>
                    </div>
                </div>
                 <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="card-title h5"><i class="fas fa-gavel me-2" aria-hidden="true"></i>Guia de Denúncia</h3>
                            <p class="technique-description-text small">Entenda seus direitos e como proceder para realizar uma denúncia formal. A Lei Maria da Penha (Lei nº 11.340/2006) estabelece os tipos de violência e as medidas protetivas.</p>
                            <a href="https://www.compromissoeatitude.org.br/principais-servicos-da-rede-de-atendimento-as-mulheres-em-situacao-de-violencia-e-contatos/" target="_blank" rel="noopener noreferrer" class="btn btn-link btn-sm p-0" style="color: var(--bs-primary);">Saiba mais sobre a Rede de Atendimento <i class="fas fa-external-link-alt fa-xs ms-1"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Categoria: Apoio Psicológico -->
            <h2 class="h4 mb-3 mt-5" style="color: var(--bs-primary-hover);">Apoio Psicológico</h2>
            <div class="row row-cols-1 row-cols-md-2 g-4">
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="card-title h5">
                                <i class="fas fa-heartbeat me-2" aria-hidden="true"></i>
                                <a href="tel:188" class="text-decoration-none" style="color: inherit;">Ligue 188 – CVV (Centro de Valorização da Vida)</a>
                            </h3>
                            <p class="technique-description-text small">Clique no número para ligar. Apoio emocional e prevenção do suicídio, gratuito e confidencial, 24 horas. Também por chat e email.</p>
                            <a href="https://www.cvv.org.br" target="_blank" rel="noopener noreferrer" class="btn btn-link btn-sm p-0" style="color: var(--bs-primary);">Acessar site do CVV <i class="fas fa-external-link-alt fa-xs ms-1"></i></a>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="card-title h5"><i class="fas fa-hands-helping me-2" aria-hidden="true"></i>Mapa do Acolhimento</h3>
                            <p class="technique-description-text small">Conecta mulheres vítimas de violência a psicólogas e advogadas voluntárias em todo o Brasil.</p>
                            <a href="https://www.mapadoacolhimento.org/" target="_blank" rel="noopener noreferrer" class="btn btn-link btn-sm p-0" style="color: var(--bs-primary);">Acessar Mapa do Acolhimento <i class="fas fa-external-link-alt fa-xs ms-1"></i></a>
                        </div>
                    </div>
                </div>
                 <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="card-title h5"><i class="fas fa-clinic-medical me-2" aria-hidden="true"></i>Centros de Referência da Mulher (CRM/CRAM)</h3>
                            <p class="technique-description-text small">Espaços que oferecem acolhimento e acompanhamento psicológico e social a mulheres em situação de violência. Busque informações na prefeitura de sua cidade ou nos sites dos governos estaduais. Muitos também oferecem orientação jurídica.</p>
                            <p class="technique-description-text small mt-2">Use o botão "Encontrar Ajuda Perto de Mim" acima para tentar localizar Centros de Referência em sua região no mapa.</p>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Categoria: Apoio Jurídico -->
            <h2 class="h4 mb-3 mt-5" style="color: var(--bs-primary-hover);">Apoio Jurídico</h2>
            <div class="row row-cols-1 row-cols-md-2 g-4">
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="card-title h5"><i class="fas fa-balance-scale me-2" aria-hidden="true"></i>Defensoria Pública</h3>
                            <p class="technique-description-text small">Oferece assistência jurídica gratuita para quem não pode pagar um advogado. Procure a Defensoria Pública do seu estado.</p>
                            <a href="https://www.anadep.org.br/wtfm_localizar_defensoria.php" target="_blank" rel="noopener noreferrer" class="btn btn-link btn-sm p-0" style="color: var(--bs-primary);">Encontrar Defensorias (ANADEP) <i class="fas fa-external-link-alt fa-xs ms-1"></i></a>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="card-title h5"><i class="fas fa-university me-2" aria-hidden="true"></i>Núcleos de Prática Jurídica (NPJ)</h3>
                            <p class="technique-description-text small">Muitas faculdades de Direito oferecem atendimento jurídico gratuito à comunidade, incluindo casos de violência doméstica. Pesquise por NPJs em universidades próximas a você.</p>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- Categoria: Abrigamento e Acolhida -->
            <h2 class="h4 mb-3 mt-5" style="color: var(--bs-primary-hover);">Abrigamento e Acolhida</h2>
            <div class="row row-cols-1 row-cols-md-2 g-4">
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="card-title h5"><i class="fas fa-house-user me-2" aria-hidden="true"></i>Casa da Mulher Brasileira</h3>
                            <p class="technique-description-text small">Integra diversos serviços (DEAM, apoio psicossocial, Ministério Público, Defensoria, Juizado, abrigo de passagem, etc.) em um só lugar. Verifique se sua cidade/estado possui uma unidade.</p>
                            <a href="https://www.gov.br/mdh/pt-br/navegue-por-temas/politicas-para-mulheres/programas-e-acoes/casa-da-mulher-brasileira" target="_blank" rel="noopener noreferrer" class="btn btn-link btn-sm p-0" style="color: var(--bs-primary);">Saiba mais sobre a Casa da Mulher Brasileira <i class="fas fa-external-link-alt fa-xs ms-1"></i></a>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="card-title h5"><i class="fas fa-home me-2" aria-hidden="true"></i>Abrigos Sigilosos e Casas de Acolhimento</h3>
                            <p class="technique-description-text small">Oferecem moradia protegida e temporária para mulheres em situação de violência e seus filhos, sob risco de vida. O acesso geralmente é feito através dos Centros de Referência da Mulher, DEAMs ou outros serviços da rede.</p>
                             <p class="technique-description-text small mt-2">Informe-se sobre os serviços de abrigamento no Centro de Referência da Mulher (CRM) ou na DEAM da sua localidade.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <footer class="text-center p-4 mt-5">
        <p class="small mb-1">© <span id="currentYear"></span> Krav Maga Woman. Todos os direitos reservados.</p>
        <p class="small opacity-75">Este aplicativo é uma ferramenta de apoio e informação. Em caso de perigo real, contate as autoridades.</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Armazena a string de configuração do Firebase para ser parseada no módulo.
        // Esta abordagem é frequentemente usada para injetar configurações do lado do servidor ou de um processo de build no JavaScript do cliente.
        const __firebase_config_str = `{
            "apiKey": "AIzaSyBfVieHjJ9lq8sYnhn4J4AhWi4W7cx9cYk",
            "authDomain": "krav-maga-woman.firebaseapp.com",
            "databaseURL": "https://krav-maga-woman-default-rtdb.firebaseio.com/",
            "projectId": "krav-maga-woman",
            "storageBucket": "krav-maga-woman.appspot.com",
            "messagingSenderId": "970804139681",
            "appId": "1:970804139681:web:YOUR_ACTUAL_WEB_APP_ID"
        }`;
        // Define um valor padrão para o ID do aplicativo, caso não seja injetado de outra forma.
        const __app_id_val = 'krav-maga-woman';
    </script>

    <script type="module">
        // W3C: Importa funções do SDK Firebase para autenticação e Realtime Database.
        // Estes são os entry points para interagir com os serviços Firebase.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth, // Para gerenciamento de autenticação (login, registro, estado do usuário)
            createUserWithEmailAndPassword, // Para registrar novos usuários com e-mail e senha
            signInWithEmailAndPassword, // Para logar usuários existentes com e-mail e senha
            onAuthStateChanged, // Observador para mudanças no estado de autenticação do usuário
            signOut // Para deslogar o usuário
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getDatabase, // Para interagir com o Firebase Realtime Database
            ref, // Cria uma referência para um local específico no banco de dados
            set, // Escreve ou substitui dados em um local específico
            get, // Lê dados de um local específico uma vez
            child, // Cria uma referência para um nó filho
            push, // Adiciona um novo nó com uma chave única gerada automaticamente
            remove, // Remove dados de um local específico
            onValue, // Escuta mudanças de dados em um local específico em tempo real
            query,      // Para criar consultas complexas no banco de dados
            orderByChild, // Para ordenar dados por um nó filho específico
            limitToLast,  // Para limitar os resultados aos últimos N itens de uma consulta
            off           // Para remover listeners de dados do Firebase, evitando memory leaks
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        /* Marcador: Inicialização Firebase */
        // Parsea a string de configuração do Firebase para um objeto JavaScript.
        const firebaseConfig = JSON.parse(__firebase_config_str);
        // Inicializa o aplicativo Firebase com as configurações fornecidas. Esta é a etapa fundamental para começar a usar os serviços do Firebase.
        const app = initializeApp(firebaseConfig);
        // Obtém a instância do serviço de Autenticação do Firebase.
        const auth = getAuth(app);
        // Obtém a instância do serviço Realtime Database do Firebase.
        const db = getDatabase(app);
        // Determina o ID do aplicativo, usando um valor injetado (__app_id) se disponível, ou o valor padrão (__app_id_val).
        const appId = typeof __app_id !== 'undefined' ? __app_id : __app_id_val;

        // Variáveis globais para armazenar o estado do aplicativo e referências importantes.
        let currentUserId = null; // Armazena o ID do usuário atualmente logado.
        let currentUserEmail = null; // Armazena o email do usuário atualmente logado.
        let locationWatchId = null; // Armazena o ID do observador de geolocalização, para poder pará-lo.
        let currentActiveAlertId = null; // Armazena o ID do alerta de emergência ativo no Firebase.
        let messageModalInstance = null; // Instância do modal de mensagens do Bootstrap.
        let nameInputModalInstance = null; // Instância do modal de inserção de nome do Bootstrap.
        let communityChatMessagesListener = null; // Referência ao listener do chat da comunidade para poder removê-lo.
        // Referência ao nó 'globalChat/messages' no Firebase Realtime Database para o chat da comunidade.
        const communityChatMessagesRef = ref(db, 'globalChat/messages'); 


        // Chave de API para o serviço CallMeBot (usado para enviar mensagens via WhatsApp - APENAS PARA TESTES).
        // IMPORTANTE: Substituir "YOUR_CALLMEBOT_WHATSAPP_APIKEY_HERE" pela chave real em um ambiente de produção ou desenvolvimento seguro.
        // Não deve ser versionada publicamente com a chave real.
        const CALLMEBOT_WHATSAPP_API_KEY = "YOUR_CALLMEBOT_WHATSAPP_APIKEY_HERE";

        // Objeto que mapeia IDs de técnicas para seus nomes e faixas, facilitando a exibição dessas informações.
        const TECHNIQUE_DETAILS = {
            "white_001": { name: "Postura de Combate e Movimentação", belt: "Faixa Branca" },
            "white_002": { name: "Soco Direto (Jab e Direto)", belt: "Faixa Branca" },
            "white_003": { name: "Defesa Simples de Soco Direto (Bloqueio 360 Externo)", belt: "Faixa Branca" },
            "yellow_001": { name: "Liberação de Agarrão de Pulso (Mesmo Lado)", belt: "Faixa Amarela" },
            "yellow_002": { name: "Chute Frontal (Pisão - Reto)", belt: "Faixa Amarela" },
        };

        /* Marcador: Elementos da Interface do Usuário (UI) */
        // Centraliza todas as referências a elementos DOM para fácil acesso e manutenção.
        // Cada propriedade corresponde a um elemento HTML identificado por seu ID.
        const uiElements = {
            loader: document.getElementById('loader'), // Elemento do spinner de carregamento.
            appHeader: document.getElementById('appHeader'), // Cabeçalho principal da aplicação.
            authPage: document.getElementById('auth-page'), // Seção da página de autenticação.
            userIdDisplay: document.getElementById('userIdDisplay'), // (Opcional) Elemento para exibir o ID do usuário.
            loginForm: document.getElementById('loginForm'), // Formulário de login.
            registerForm: document.getElementById('registerForm'), // Formulário de registro.
            showRegisterLink: document.getElementById('showRegister'), // Link para mostrar o formulário de registro.
            showLoginLink: document.getElementById('showLogin'), // Link para mostrar o formulário de login.
            switchToLoginP: document.getElementById('switchToLogin'), // Parágrafo contendo o link para login.
            logoutButton: document.getElementById('logoutButton'), // Botão de logout.
            mobileMenu: document.getElementById('mobileMenu'), // Menu de navegação mobile (colapsável).
            messageModal: document.getElementById('messageModal'), // Modal para exibir mensagens/notificações.
            messageText: document.getElementById('messageText'), // Elemento de texto dentro do modal de mensagens.
            messageModalTitle: document.getElementById('messageModalTitle'), // Título do modal de mensagens.
            quizContainer: document.getElementById('quizContainer'), // Container para o quiz.
            quizResult: document.getElementById('quizResult'), // Container para exibir o resultado do quiz.
            quizScoreDisplay: document.getElementById('quizScore'), // Elemento para mostrar a pontuação do quiz.
            retakeQuizButton: document.getElementById('retakeQuizButton'), // Botão para refazer o quiz.
            emergencyButton: document.getElementById('emergencyButton'), // Botão de alerta de emergência.
            emergencyStatus: document.getElementById('emergencyStatus'), // Elemento para exibir o status do alerta.
            contactNameInput: document.getElementById('contactName'), // Input para o nome do contato de emergência.
            contactDetailInput: document.getElementById('contactDetail'), // Input para o detalhe (telefone/user) do contato de emergência.
            addContactButton: document.getElementById('addContactButton'), // Botão para adicionar contato de emergência.
            contactsListDiv: document.getElementById('contactsList'), // Div para listar os contatos de emergência.
            currentYearEl: document.getElementById('currentYear'), // Elemento para exibir o ano atual no rodapé.
            themeToggleButton: document.getElementById('themeToggle'), // Botão para alternar tema (desktop).
            themeToggleButtonMobile: document.getElementById('themeToggleMobile'), // Botão para alternar tema (mobile).
            viewNotesPage: document.getElementById('view-notes-page'), // Seção da página de visualização de anotações.
            whiteBeltNotesContainer: document.getElementById('whiteBeltNotesContainer'), // Container para anotações da faixa branca.
            yellowBeltNotesContainer: document.getElementById('yellowBeltNotesContainer'), // Container para anotações da faixa amarela.
            chatMessagesWarning: document.getElementById('chatMessagesWarning'), // Área de mensagens do chatbot de Sinais de Alerta.
            chatInputWarning: document.getElementById('chatInputWarning'), // Input de texto do chatbot de Sinais de Alerta.
            sendWarningChatButton: document.getElementById('sendWarningChatButton'), // Botão de envio do chatbot de Sinais de Alerta.
            chatbotPostInteractionLinks: document.getElementById('chatbotPostInteractionLinks'), // Container para links pós-chat.
            communityChatContainer: document.getElementById('communityChatContainer'), // Container principal do chat da comunidade.
            communityChatMessagesArea: document.getElementById('communityChatMessagesArea'), // Área de exibição das mensagens do chat da comunidade.
            communityChatInput: document.getElementById('communityChatInput'), // Input de texto do chat da comunidade.
            sendCommunityChatMessageButton: document.getElementById('sendCommunityChatMessageButton'), // Botão de envio do chat da comunidade.
            // Elementos para nome de exibição
            dashboardWelcomeMessage: document.getElementById('dashboardWelcomeMessage'), // Mensagem de boas-vindas no dashboard.
            displayNameSpan: document.getElementById('displayNameSpan'), // Span para exibir o nome do usuário.
            displayNamePromptContainer: document.getElementById('displayNamePromptContainer'), // Container do prompt para inserir nome.
            displayNamePromptLink: document.getElementById('displayNamePromptLink'), // Link para abrir o modal de inserção de nome.
            nameInputModal: document.getElementById('nameInputModal'), // Modal para inserir/editar nome de exibição.
            nameInputField: document.getElementById('nameInputField'), // Campo de input dentro do modal de nome.
            saveNameButton: document.getElementById('saveNameButton'), // Botão para salvar o nome no modal.
            // Elementos da Página de Suporte
            findSupportNearMeButton: document.getElementById('findSupportNearMeButton'), // Botão para busca geolocalizada
        };

        // Inicializa a instância do modal de mensagens do Bootstrap, se o elemento existir.
        if (uiElements.messageModal) {
            messageModalInstance = new bootstrap.Modal(uiElements.messageModal);
        }
        // Inicializa a instância do modal de inserção de nome do Bootstrap, se o elemento existir.
        if (uiElements.nameInputModal) { 
            nameInputModalInstance = new bootstrap.Modal(uiElements.nameInputModal);
        }

        /* Marcador: Funções Utilitárias */

        /**
         * Exibe o loader (spinner) de carregamento.
         * Usado para indicar operações assíncronas em andamento.
         */
        function showLoader() { if (uiElements.loader) uiElements.loader.style.display = 'block'; }
        
        /**
         * Oculta o loader (spinner) de carregamento.
         */
        function hideLoader() { if (uiElements.loader) uiElements.loader.style.display = 'none'; }

        /**
         * Exibe uma mensagem para o usuário usando o modal de mensagens.
         * @param {string} message - A mensagem a ser exibida.
         * @param {boolean} [isError=false] - Define se a mensagem é um erro (para estilizar o título do modal, por exemplo).
         */
        function showMessage(message, isError = false) {
            if (uiElements.messageText) uiElements.messageText.textContent = message;
            if (uiElements.messageModalTitle) uiElements.messageModalTitle.textContent = isError ? "Erro" : "Notificação";
            if (messageModalInstance) messageModalInstance.show();
        }

        /**
         * Traduz códigos de erro de autenticação do Firebase para mensagens amigáveis ao usuário.
         * @param {string} errorCode - O código de erro retornado pelo Firebase Auth.
         * @returns {string} - A mensagem de erro traduzida.
         */
        function getFriendlyAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email': return 'O formato do e-mail fornecido é inválido.';
                case 'auth/user-disabled': return 'Esta conta de usuário foi desabilitada.';
                case 'auth/user-not-found': return 'Nenhum usuário encontrado com este e-mail.';
                case 'auth/wrong-password': return 'A senha está incorreta.';
                case 'auth/email-already-in-use': return 'Este e-mail já está sendo utilizado por outra conta.';
                case 'auth/operation-not-allowed': return 'Operação não permitida. O login por e-mail/senha pode estar desabilitado.';
                case 'auth/weak-password': return 'A senha fornecida é muito fraca. Use pelo menos 6 caracteres.';
                case 'auth/missing-email': return 'Por favor, insira seu e-mail.';
                case 'auth/missing-password': return 'Por favor, insira sua senha.';
                default: return 'Ocorreu um erro desconhecido durante a autenticação. Tente novamente.';
            }
        }

        /**
         * Gera um nome de exibição para o chat a partir do e-mail do usuário.
         * Pega a parte do e-mail antes do "@".
         * @param {string} email - O e-mail do usuário.
         * @returns {string} - O nome de exibição gerado ou 'Anônima' se o e-mail for inválido.
         */
        function getUserDisplayNameForChat(email) { 
            if (!email) return 'Anônima';
            return email.split('@')[0];
        }

        /**
         * Formata um timestamp ISO para uma string de hora local (HH:MM).
         * @param {string} isoTimestamp - O timestamp no formato ISO (ex: "2023-10-27T10:30:00.000Z").
         * @returns {string} - A hora formatada ou uma string vazia em caso de erro.
         */
        function getFormattedTimestamp(isoTimestamp) {
            if (!isoTimestamp) return '';
            try {
                return new Date(isoTimestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            } catch (e) { return ''; }
        }

        /* Marcador: Funções de Nome de Exibição (Perfil) */

        /**
         * Atualiza a interface do usuário com a mensagem de boas-vindas, incluindo o nome de exibição.
         * Se não houver nome, mostra um prompt para o usuário definir um.
         * @param {string|null} displayName - O nome de exibição do usuário ou null.
         */
        function updateWelcomeMessageUI(displayName) {
            if (uiElements.displayNameSpan && uiElements.displayNamePromptContainer) {
                if (displayName && displayName.trim() !== "") {
                    uiElements.displayNameSpan.textContent = `, ${displayName}`; // Adiciona vírgula e espaço antes do nome.
                    uiElements.displayNamePromptContainer.style.display = 'none'; // Oculta o prompt para adicionar nome.
                } else {
                    uiElements.displayNameSpan.textContent = ''; // Limpa o nome se não houver.
                    uiElements.displayNamePromptContainer.style.display = 'inline'; // Mostra o prompt para adicionar nome.
                }
            }
        }

        /**
         * Carrega o nome de exibição do usuário do Firebase Realtime Database e atualiza a UI.
         * Chamado quando o usuário faz login ou navega para o dashboard.
         */
        async function loadAndSetDisplayName() {
            if (!currentUserId) { // Se não houver usuário logado, não faz nada e garante que o prompt apareça.
                updateWelcomeMessageUI(null); 
                return;
            }
            try {
                const displayNameRef = ref(db, `users/${currentUserId}/profile/displayName`); // Caminho para o nome no DB.
                const snapshot = await get(displayNameRef); // Lê o valor do DB.
                if (snapshot.exists() && snapshot.val().trim() !== "") {
                    updateWelcomeMessageUI(snapshot.val()); // Atualiza UI com o nome do DB.
                } else {
                    updateWelcomeMessageUI(null); // Se não houver nome no DB, mostra o prompt.
                }
            } catch (error) {
                console.error("Erro ao carregar nome de exibição:", error);
                updateWelcomeMessageUI(null); // Em caso de erro, mostra o prompt.
            }
        }

        /**
         * Salva o novo nome de exibição fornecido pelo usuário no Firebase Realtime Database.
         * Chamado quando o usuário clica em "Salvar" no modal de nome.
         */
        async function handleSaveDisplayName() {
            if (!currentUserId || !uiElements.nameInputField) return; // Verifica se há usuário e input.
            const newName = uiElements.nameInputField.value.trim(); // Pega o valor do input e remove espaços.

            if (newName === "") { // Validação simples para nome vazio.
                showMessage("Por favor, insira um nome.", true);
                return;
            }
            showLoader(); // Mostra o loader durante a operação.
            try {
                const displayNameRef = ref(db, `users/${currentUserId}/profile/displayName`);
                await set(displayNameRef, newName); // Salva o novo nome no DB.
                updateWelcomeMessageUI(newName); // Atualiza a UI imediatamente.
                if (nameInputModalInstance) nameInputModalInstance.hide(); // Fecha o modal.
                showMessage("Nome salvo com sucesso!");
                uiElements.nameInputField.value = ''; // Limpa o campo do input no modal.
            } catch (error) {
                console.error("Erro ao salvar nome de exibição:", error);
                showMessage("Erro ao salvar nome. Tente novamente.", true);
            } finally {
                hideLoader(); // Esconde o loader ao final da operação.
            }
        }

        /**
         * Configura os event listeners para o prompt de nome de exibição (link para abrir modal e botão de salvar).
         */
        function setupDisplayNamePrompt() {
            // Adiciona listener ao link para abrir o modal de nome.
            if (uiElements.displayNamePromptLink) {
                uiElements.displayNamePromptLink.addEventListener('click', (e) => {
                    e.preventDefault(); // Previne o comportamento padrão do link.
                    if (nameInputModalInstance) nameInputModalInstance.show(); // Mostra o modal.
                    // Adiciona foco ao campo de input quando o modal é aberto para melhor UX.
                    setTimeout(() => {
                        if (uiElements.nameInputField) uiElements.nameInputField.focus();
                    }, 500); // Delay para garantir que o modal esteja visível antes de focar.
                });
            }
            // Adiciona listener ao botão de salvar nome no modal.
            if (uiElements.saveNameButton) {
                uiElements.saveNameButton.addEventListener('click', handleSaveDisplayName);
            }
            // Adiciona listener para salvar com "Enter" no campo de nome.
             if (uiElements.nameInputField) {
                uiElements.nameInputField.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Previne submissão de formulário, se houver.
                        handleSaveDisplayName(); // Chama a função de salvar.
                    }
                });
            }
        }


        /* Marcador: Funções de Navegação */
        // Coleção de todas as seções de página do HTML.
        const pageSections = document.querySelectorAll('.page-section');

        /**
         * Controla a visibilidade das diferentes seções (páginas) do aplicativo.
         * Ativa a página solicitada e desativa as outras.
         * Também executa ações específicas ao navegar para certas páginas (ex: carregar dados).
         * @param {string} pageId - O ID da seção da página a ser exibida.
         */
        function navigateToPage(pageId) {
            // Itera sobre todas as seções da página.
            pageSections.forEach(section => {
                const isActivePage = section.id === pageId; // Verifica se a seção atual é a que deve ser ativada.
                section.classList.toggle('active', isActivePage); // Adiciona/remove a classe 'active'.
                // Tratamento especial para a página de autenticação que usa display: flex.
                if (section.id === 'auth-page') {
                    section.style.display = isActivePage ? 'flex' : 'none';
                } else {
                    section.style.display = isActivePage ? 'block' : 'none';
                }
            });

            // Remove o listener do chat da comunidade para evitar múltiplas execuções ou consumo desnecessário de recursos.
            detachCommunityChatListener(); 

            // Lógica específica para executar ao carregar certas páginas.
            if (pageId === 'dashboard-page' && currentUserId) {
                loadAndSetDisplayName(); // Carrega o nome do usuário no dashboard.
                loadCommunityChatMessages(); // Carrega as mensagens do chat da comunidade.
            }
            if (pageId === 'view-notes-page') {
                loadAndDisplayAllNotes(); // Carrega e exibe todas as anotações do usuário.
            }
            if (pageId === 'quiz-page') {
                // Carrega o quiz somente se não estiver já carregado ou se o resultado estiver visível (indicando que pode ser refeito).
                if ((!document.getElementById('currentQuizForm') && uiElements.quizContainer) || (uiElements.quizResult && uiElements.quizResult.style.display !== 'none')) {
                    loadQuiz();
                }
            }
            if (pageId === 'warnings-page') {
                initializeWarningChatbot(); // Inicializa o chatbot de sinais de alerta.
                 if (uiElements.chatbotPostInteractionLinks) { // Esconde os links de sugestão ao (re)navegar para a página
                    uiElements.chatbotPostInteractionLinks.style.display = 'none';
                }
            } else {
                 // Esconde os links de sugestão do chatbot se navegar para fora da página de warnings
                 if (uiElements.chatbotPostInteractionLinks) {
                    uiElements.chatbotPostInteractionLinks.style.display = 'none';
                }
            }


            // Atualiza o estado ativo dos links de navegação no cabeçalho.
            document.querySelectorAll('#appHeader .nav-link.navigate-to').forEach(link => {
                link.classList.toggle('active', link.dataset.page === pageId);
            });

            // Fecha o menu mobile (se estiver aberto) após a navegação.
            const mobileMenuEl = uiElements.mobileMenu;
            if (mobileMenuEl && mobileMenuEl.classList.contains('show')) {
                const bsCollapse = bootstrap.Collapse.getInstance(mobileMenuEl) || new bootstrap.Collapse(mobileMenuEl, {toggle: false});
                bsCollapse.hide();
            }
            // Rola a página para o topo após a navegação.
            window.scrollTo(0, 0);
        }

        /**
         * Configura os event listeners para todos os links de navegação.
         * Isso inclui links normais e cards que funcionam como links.
         */
        function setupNavigation() {
            document.querySelectorAll('.navigate-to').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault(); // Previne o comportamento padrão do link/elemento.
                    const pageId = e.currentTarget.dataset.page; // Obtém o ID da página do atributo data-page.
                    if (pageId) navigateToPage(pageId); // Navega para a página.
                });
                // Adiciona suporte para navegação via teclado (Enter/Espaço) para cards navegáveis, melhorando a acessibilidade.
                if (link.classList.contains('card') || link.tagName === 'BUTTON' && link.classList.contains('navigate-to')) {
                    link.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') { // Se Enter ou Espaço forem pressionados.
                            e.preventDefault();
                            const pageId = e.currentTarget.dataset.page;
                            if (pageId) navigateToPage(pageId);
                        }
                    });
                }
            });
        }

        /* Marcador: Funções de Autenticação */

        /**
         * Configura os event listeners para os formulários de login, registro e botões de logout/troca de formulário.
         */
        function setupAuthEventListeners() {
            if (uiElements.loginForm) uiElements.loginForm.addEventListener('submit', handleLogin);
            if (uiElements.registerForm) uiElements.registerForm.addEventListener('submit', handleRegister);
            if (uiElements.showRegisterLink) uiElements.showRegisterLink.addEventListener('click', (e) => toggleAuthForms(e, 'register'));
            if (uiElements.showLoginLink) uiElements.showLoginLink.addEventListener('click', (e) => toggleAuthForms(e, 'login'));
            if (uiElements.logoutButton) uiElements.logoutButton.addEventListener('click', handleLogout);
        }

        /**
         * Alterna a exibição entre os formulários de login e registro.
         * @param {Event} e - O objeto do evento (geralmente de um clique).
         * @param {string} targetForm - 'login' ou 'register', indicando qual formulário mostrar.
         */
        function toggleAuthForms(e, targetForm) {
            e.preventDefault(); // Previne o comportamento padrão do link.
            const isLoginTarget = targetForm === 'login';
            // Mostra/oculta os formulários apropriados.
            uiElements.loginForm.style.display = isLoginTarget ? 'block' : 'none';
            uiElements.registerForm.style.display = isLoginTarget ? 'none' : 'block';
            // Mostra/oculta os links para alternar entre os formulários.
            const registerLinkP = uiElements.showRegisterLink.parentElement;
            if(registerLinkP) registerLinkP.style.display = isLoginTarget ? 'block' : 'none';
            if(uiElements.switchToLoginP) uiElements.switchToLoginP.style.display = isLoginTarget ? 'none' : 'block';
            
            // Limpa o formulário que está sendo ocultado e foca no primeiro campo do formulário que está sendo exibido.
            if (isLoginTarget) {
                if(uiElements.registerForm) uiElements.registerForm.reset(); 
                const firstLoginInput = uiElements.loginForm.querySelector('input#loginEmail'); 
                if (firstLoginInput && typeof firstLoginInput.focus === 'function') firstLoginInput.focus();
            } else { 
                if(uiElements.loginForm) uiElements.loginForm.reset(); 
                const firstRegisterInput = uiElements.registerForm.querySelector('input#registerEmail'); 
                if (firstRegisterInput && typeof firstRegisterInput.focus === 'function') firstRegisterInput.focus();
            }
        }

        /**
         * Manipula a submissão do formulário de login.
         * @param {Event} e - O objeto do evento de submissão.
         */
        async function handleLogin(e) {
            e.preventDefault(); // Previne a submissão padrão do formulário.
            showLoader(); // Mostra o loader.
            const email = uiElements.loginForm.loginEmail.value.trim();
            const password = uiElements.loginForm.loginPassword.value.trim();

            // Validações básicas de preenchimento.
            if (!email && !password) { showMessage("Por favor, preencha o e-mail e a senha.", true); hideLoader(); return; }
            if (!email) { showMessage("Por favor, preencha o campo de e-mail.", true); hideLoader(); return; }
            if (!password) { showMessage("Por favor, preencha o campo de senha.", true); hideLoader(); return; }

            try {
                // Tenta fazer login com e-mail e senha usando Firebase Auth.
                await signInWithEmailAndPassword(auth, email, password);
                uiElements.loginForm.reset(); // Limpa o formulário após o login.
                // O onAuthStateChanged cuidará da navegação.
            } catch (error) {
                console.error("Erro no login:", error, error.code);
                showMessage(getFriendlyAuthErrorMessage(error.code), true); // Mostra mensagem de erro amigável.
            } finally {
                hideLoader(); // Esconde o loader.
            }
        }

        /**
         * Manipula a submissão do formulário de registro.
         * @param {Event} e - O objeto do evento de submissão.
         */
        async function handleRegister(e) {
            e.preventDefault(); 
            showLoader();
            const email = uiElements.registerForm.registerEmail.value.trim();
            const password = uiElements.registerForm.registerPassword.value.trim();
            const confirmPassword = uiElements.registerForm.registerConfirmPassword.value.trim();

            // Validações de preenchimento e senha.
            if (!email || !password || !confirmPassword) { showMessage("Por favor, preencha todos os campos para o cadastro.", true); hideLoader(); return; }
            if (password.length < 6) { showMessage("A senha deve ter pelo menos 6 caracteres.", true); hideLoader(); return; }
            if (password !== confirmPassword) { showMessage("As senhas não coincidem.", true); hideLoader(); return; }

            try {
                // Cria um novo usuário com e-mail e senha usando Firebase Auth.
                await createUserWithEmailAndPassword(auth, email, password);
                // Desloga o usuário recém-criado para forçá-lo a fazer login manualmente (opcional, mas comum).
                await signOut(auth); 
                showMessage("Cadastro realizado com sucesso! Faça login para continuar.");
                uiElements.registerForm.reset(); // Limpa o formulário.
                toggleAuthForms(e, 'login'); // Alterna para o formulário de login.
            } catch (error) {
                console.error("Erro no cadastro:", error, error.code);
                showMessage(getFriendlyAuthErrorMessage(error.code), true);
            } finally {
                hideLoader();
            }
        }

        /**
         * Manipula o evento de logout do usuário.
         */
        function handleLogout() {
            showLoader();
            signOut(auth).catch(error => { // Desloga o usuário.
                console.error("Erro ao sair:", error);
                showMessage(getFriendlyAuthErrorMessage(error.code), true);
            }).finally(() => hideLoader());
            // O onAuthStateChanged cuidará da navegação para a página de autenticação.
        }

        /**
         * Observador do estado de autenticação do Firebase.
         * Esta função é chamada sempre que o estado de login do usuário muda (login, logout).
         * É o ponto central para controlar o que acontece quando um usuário está logado ou deslogado.
         * @param {firebase.User|null} user - O objeto do usuário (se logado) ou null (se deslogado).
         */
        onAuthStateChanged(auth, (user) => {
            showLoader();
            if (user) { // Usuário está logado.
                currentUserId = user.uid; // Armazena o ID do usuário.
                currentUserEmail = user.email; // Armazena o e-mail do usuário.
                if (uiElements.userIdDisplay) uiElements.userIdDisplay.textContent = currentUserId; // (Opcional) Exibe o ID do usuário.
                if (uiElements.appHeader) uiElements.appHeader.style.display = 'block'; // Mostra o cabeçalho do app.
                
                // Lógica para decidir para qual página navegar após o login.
                const onAuthPage = document.getElementById('auth-page').classList.contains('active');
                const noOtherPageActive = !Array.from(pageSections).some(s => s.classList.contains('active') && s.id !== 'auth-page');

                if (onAuthPage || noOtherPageActive) { // Se estava na página de auth ou nenhuma outra ativa, vai para o dashboard.
                    navigateToPage('dashboard-page'); 
                } else { // Se já estava em outra página, recarrega os dados dessa página se necessário.
                    pageSections.forEach(section => {
                        if (section.classList.contains('active')) {
                            if (section.id === 'dashboard-page') { // Se já estava no dashboard, recarrega nome e chat.
                                loadAndSetDisplayName();
                                loadCommunityChatMessages();
                            } else if (section.id === 'warnings-page') { // Se estava nos sinais de alerta, reinicializa o chatbot.
                                initializeWarningChatbot();
                            }
                        }
                    });
                }
                loadUserNotes(); // Carrega as anotações do usuário.
                loadEmergencyContacts(); // Carrega os contatos de emergência do usuário.
            } else { // Usuário está deslogado.
                currentUserId = null;
                currentUserEmail = null;
                updateWelcomeMessageUI(null); // Limpa a mensagem de boas-vindas.
                detachCommunityChatListener(); // Remove o listener do chat.
                if (uiElements.appHeader) uiElements.appHeader.style.display = 'none'; // Esconde o cabeçalho.
                
                // Configura a página de autenticação para ser exibida.
                if (uiElements.loginForm) uiElements.loginForm.style.display = 'block';
                if (uiElements.registerForm) uiElements.registerForm.style.display = 'none';
                const registerLinkP = uiElements.showRegisterLink ? uiElements.showRegisterLink.parentElement : null;
                if(registerLinkP) registerLinkP.style.display = 'block'; 
                if(uiElements.switchToLoginP) uiElements.switchToLoginP.style.display = 'none'; 

                navigateToPage('auth-page'); // Navega para a página de autenticação.
                // Foca no campo de e-mail do login para melhor UX.
                const firstLoginInput = uiElements.loginForm ? uiElements.loginForm.querySelector('#loginEmail') : null;
                if (firstLoginInput && typeof firstLoginInput.focus === 'function') {
                    setTimeout(() => firstLoginInput.focus(), 0); // Timeout para garantir que o elemento está visível.
                }
            }
            hideLoader();
        });

        /* Marcador: Funções de Anotações */

        /**
         * Configura os event listeners para os botões de salvar anotação nas páginas de técnicas.
         */
        function setupNotesEventListeners() {
            document.querySelectorAll('.save-note-button').forEach(button => {
                button.addEventListener('click', handleSaveNoteForTechniquePage);
            });
        }

        /**
         * Carrega as anotações do usuário do Firebase e preenche as textareas correspondentes nas páginas de técnicas.
         */
        async function loadUserNotes() {
            if (!currentUserId) return; // Só executa se houver um usuário logado.
            showLoader();
            try {
                const notesSnapshot = await get(child(ref(db), `users/${currentUserId}/notes`)); // Lê o nó 'notes' do usuário.
                if (notesSnapshot.exists()) {
                    const notes = notesSnapshot.val();
                    // Preenche cada textarea com a anotação correspondente.
                    document.querySelectorAll('.notes-area').forEach(area => {
                        const techniqueId = area.dataset.techniqueId;
                        if (notes[techniqueId]) {
                            // Suporta tanto o formato antigo (string) quanto o novo (objeto com text e updatedAt).
                            area.value = typeof notes[techniqueId] === 'string' ? notes[techniqueId] : (notes[techniqueId].text || '');
                        } else { area.value = ''; } // Limpa se não houver anotação.
                    });
                } else { // Se não houver anotações, limpa todas as textareas.
                    document.querySelectorAll('.notes-area').forEach(area => area.value = '');
                }
            } catch (error) { 
                console.error("Erro ao carregar anotações:", error); 
                showMessage("Não foi possível carregar suas anotações.", true); 
            }
            finally { hideLoader(); }
        }

        /**
         * Salva a anotação de uma técnica específica. Chamado pelas páginas de técnicas.
         * @param {Event} e - O objeto do evento de clique no botão "Salvar Anotação".
         */
        async function handleSaveNoteForTechniquePage(e) {
            if (!currentUserId) { showMessage("Você precisa estar logada para salvar anotações.", true); return; }
            showLoader();
            const button = e.target.closest('button'); // Garante que pegamos o botão, mesmo se o clique for no ícone.
            if (!button) { hideLoader(); return; } // Segurança.
            const techniqueId = button.dataset.techniqueId; // ID da técnica (ex: "white_001").
            const noteTextArea = document.querySelector(`textarea[data-technique-id="${techniqueId}"]`);
            if (!noteTextArea) { hideLoader(); showMessage("Erro: área de anotação não encontrada.", true); return; }
            const noteText = noteTextArea.value; // Conteúdo da anotação.

            try {
                // Salva a anotação no Firebase, incluindo um timestamp de atualização.
                await set(ref(db, `users/${currentUserId}/notes/${techniqueId}`), {
                    text: noteText,
                    updatedAt: new Date().toISOString() // Salva data no formato ISO.
                });
                showMessage("Anotação salva com sucesso!");
            }
            catch (error) {
                let errorMessage = "Ocorreu um erro desconhecido.";
                if (error && typeof error.message === 'string') errorMessage = error.message;
                console.error("Erro ao salvar anotação:", error); 
                showMessage("Erro ao salvar anotação: " + errorMessage, true);
            }
            finally { hideLoader(); }
        }

        /**
         * Carrega todas as anotações do usuário e as exibe na página "Ver Anotações".
         */
        async function loadAndDisplayAllNotes() {
            if (!currentUserId) { // Verifica se o usuário está logado.
                if (uiElements.whiteBeltNotesContainer) uiElements.whiteBeltNotesContainer.innerHTML = '<p class="text-muted-light">Você precisa estar logada para ver suas anotações.</p>';
                if (uiElements.yellowBeltNotesContainer) uiElements.yellowBeltNotesContainer.innerHTML = ''; // Limpa o outro container.
                return;
            }
            showLoader();
            // Mensagens de carregamento.
            if (uiElements.whiteBeltNotesContainer) uiElements.whiteBeltNotesContainer.innerHTML = '<p class="text-muted-light">Carregando anotações...</p>';
            if (uiElements.yellowBeltNotesContainer) uiElements.yellowBeltNotesContainer.innerHTML = '<p class="text-muted-light">Carregando anotações...</p>';

            try {
                const notesSnapshot = await get(child(ref(db), `users/${currentUserId}/notes`));
                let whiteBeltHtml = ''; 
                let yellowBeltHtml = '';
                let hasWhiteNotes = false; 
                let hasYellowNotes = false;

                if (notesSnapshot.exists()) {
                    const notes = notesSnapshot.val();
                    for (const techniqueId in notes) { // Itera sobre cada anotação.
                        const noteData = notes[techniqueId];
                        const noteText = typeof noteData === 'string' ? noteData : (noteData.text || ''); // Compatibilidade com formato antigo.
                        const updatedAt = typeof noteData === 'object' && noteData.updatedAt ? new Date(noteData.updatedAt).toLocaleString('pt-BR') : 'Data indisponível';
                        const techniqueInfo = TECHNIQUE_DETAILS[techniqueId] || { name: `Técnica (${techniqueId})`, belt: "Desconhecida" };
                        
                        // Cria o HTML do card para cada anotação.
                        const noteCardHtml = `
                            <div class="note-card p-3 rounded shadow-sm mb-3" data-technique-id="${techniqueId}">
                                <h3>${techniqueInfo.name}</h3> <p class="timestamp">${updatedAt}</p>
                                <div class="note-content"><p class="note-text-display small">${noteText.replace(/\n/g, '<br>')}</p></div>
                                <div class="edit-buttons mt-2">
                                    <button class="btn btn-sm btn-secondary edit-note-btn"><i class="fas fa-edit me-1"></i>Editar</button>
                                    <button class="btn btn-sm btn-primary save-note-view-btn d-none"><i class="fas fa-save me-1"></i>Salvar</button>
                                    <button class="btn btn-sm btn-outline-secondary cancel-edit-btn d-none ms-1"><i class="fas fa-times me-1"></i>Cancelar</button>
                                </div>
                            </div>`;
                        // Separa as anotações por faixa.
                        if (techniqueId.startsWith('white_')) { whiteBeltHtml += noteCardHtml; hasWhiteNotes = true; } 
                        else if (techniqueId.startsWith('yellow_')) { yellowBeltHtml += noteCardHtml; hasYellowNotes = true; }
                    }
                }
                // Exibe as anotações ou mensagens de "nenhuma anotação".
                if (uiElements.whiteBeltNotesContainer) uiElements.whiteBeltNotesContainer.innerHTML = hasWhiteNotes ? whiteBeltHtml : '<p class="text-muted-light">Nenhuma anotação para a Faixa Branca ainda.</p>';
                if (uiElements.yellowBeltNotesContainer) uiElements.yellowBeltNotesContainer.innerHTML = hasYellowNotes ? yellowBeltHtml : '<p class="text-muted-light">Nenhuma anotação para a Faixa Amarela ainda.</p>';
                
                addEventListenersToNoteCards(); // Adiciona listeners aos botões de editar/salvar dos cards recém-criados.
            } catch (error) {
                console.error("Erro ao carregar todas as anotações:", error);
                showMessage("Não foi possível carregar suas anotações.", true);
                if (uiElements.whiteBeltNotesContainer) uiElements.whiteBeltNotesContainer.innerHTML = '<p class="text-danger">Erro ao carregar anotações.</p>';
                if (uiElements.yellowBeltNotesContainer) uiElements.yellowBeltNotesContainer.innerHTML = '<p class="text-danger">Erro ao carregar anotações.</p>';
            } finally {
                hideLoader();
            }
        }

        /**
         * Adiciona event listeners aos botões de "Editar", "Salvar" e "Cancelar" nos cards de anotação da página "Ver Anotações".
         */
        function addEventListenersToNoteCards() {
            document.querySelectorAll('.edit-note-btn').forEach(button => button.addEventListener('click', handleEditNoteOnViewPage));
            document.querySelectorAll('.save-note-view-btn').forEach(button => button.addEventListener('click', handleSaveNoteOnViewPage));
            document.querySelectorAll('.cancel-edit-btn').forEach(button => button.addEventListener('click', handleCancelEditOnViewPage));
        }

        /**
         * Transforma o parágrafo de texto de uma anotação em uma textarea para edição na página "Ver Anotações".
         * @param {Event} e - O objeto do evento de clique no botão "Editar".
         */
        function handleEditNoteOnViewPage(e) {
            const noteCard = e.target.closest('.note-card');
            const noteContentDiv = noteCard.querySelector('.note-content');
            const textDisplayP = noteCard.querySelector('.note-text-display');
            const currentText = textDisplayP.innerHTML.replace(/<br\s*\/?>/gi, '\n'); // Converte <br> de volta para \n para edição.

            const textArea = document.createElement('textarea');
            textArea.className = 'notes-area-view form-control form-control-sm w-100'; // Usa classe específica para view page.
            textArea.value = currentText; 
            textArea.rows = 4; // Altura da textarea.

            noteContentDiv.innerHTML = ''; // Limpa o conteúdo atual (o <p>).
            noteContentDiv.appendChild(textArea); // Adiciona a textarea.
            textArea.focus(); // Foca na textarea.

            // Alterna a visibilidade dos botões.
            noteCard.querySelector('.edit-note-btn').classList.add('d-none');
            noteCard.querySelector('.save-note-view-btn').classList.remove('d-none');
            noteCard.querySelector('.cancel-edit-btn').classList.remove('d-none');
        }

        /**
         * Salva a anotação editada na página "Ver Anotações".
         * @param {Event} e - O objeto do evento de clique no botão "Salvar".
         */
        async function handleSaveNoteOnViewPage(e) {
            const noteCard = e.target.closest('.note-card');
            const techniqueId = noteCard.dataset.techniqueId;
            const textArea = noteCard.querySelector('textarea.notes-area-view');
            const newText = textArea.value;

            if (!currentUserId) { showMessage("Você precisa estar logada.", true); return; }
            showLoader();
            try {
                // Atualiza a anotação no Firebase.
                await set(ref(db, `users/${currentUserId}/notes/${techniqueId}`), { text: newText, updatedAt: new Date().toISOString() });
                showMessage("Anotação atualizada!");
                loadAndDisplayAllNotes(); // Recarrega todas as anotações para refletir a mudança.
            } catch (error) { 
                console.error("Erro ao salvar anotação na ViewPage:", error); 
                showMessage("Erro ao salvar anotação: " + error.message, true); 
            }
            finally { hideLoader(); }
        }
        
        /**
         * Cancela a edição de uma anotação na página "Ver Anotações", recarregando as anotações originais.
         * @param {Event} e - O objeto do evento de clique no botão "Cancelar".
         */
        function handleCancelEditOnViewPage(e) { 
            loadAndDisplayAllNotes(); // Simplesmente recarrega as notas, descartando quaisquer alterações não salvas.
        }

        /* Marcador: Funções de Quiz */
        const sampleQuiz = {
            title: "Conhecimentos de Krav Maga e Defesa Pessoal",
            questions: [
                { text: "Qual o principal objetivo da postura de combate no Krav Maga?", options: ["Aparência intimidadora", "Proteção e mobilidade", "Descanso entre movimentos", "Facilitar o ataque surpresa"], correctAnswer: "Proteção e mobilidade" },
                { text: "O soco 'Direto' geralmente é desferido com qual mão por um lutador destro?", options: ["Mão da frente (esquerda)", "Mão de trás (direita)", "Ambas simultaneamente", "Qualquer uma"], correctAnswer: "Mão de trás (direita)" },
                { text: "Ao se defender de um agarrão de pulso (mesmo lado), para onde você deve girar seu pulso?", options: ["Na direção dos dedos do agressor", "Para baixo", "Na direção do polegar do agressor", "Para cima e para trás"], correctAnswer: "Na direção do polegar do agressor" },
                { text: "Qual é um princípio fundamental do Krav Maga em relação à defesa?", options: ["Sempre esperar o primeiro ataque", "Usar apenas técnicas complexas", "Defender e contra-atacar simultaneamente ou o mais rápido possível", "Lutar apenas em competições"], correctAnswer: "Defender e contra-atacar simultaneamente ou o mais rápido possível" },
                { text: "Em uma situação de perigo, qual a primeira recomendação antes de qualquer ação física?", options: ["Gritar por ajuda imediatamente", "Atacar o agressor preventivamente", "Tentar fugir ou evitar o confronto (prevenção)", "Filmar a situação"], correctAnswer: "Tentar fugir ou evitar o confronto (prevenção)" },
                { text: "Qual parte do pé é comumente usada para um chute frontal defensivo (pisão) no Krav Maga?", options: ["Peito do pé", "Calcanhar ou sola do pé", "Lateral do pé", "Ponta dos dedos"], correctAnswer: "Calcanhar ou sola do pé" },
                { text: "O que significa 'Retzev' no Krav Maga?", options: ["Uma técnica de soco específica", "Movimento contínuo ou combate contínuo", "Um tipo de queda", "Posição de espera"], correctAnswer: "Movimento contínuo ou combate contínuo" },
                { text: "Ao ser abordada por um agressor, qual a importância de usar a voz de forma firme e alta?", options: ["Apenas para intimidar o agressor", "Para mostrar conhecimento técnico", "Atrair atenção, pedir ajuda e demonstrar que não é um alvo fácil", "Não tem importância, o silêncio é melhor"], correctAnswer: "Atrair atenção, pedir ajuda e demonstrar que não é um alvo fácil" },
                { text: "Qual destes NÃO é considerado um ponto vulnerável primário no Krav Maga?", options: ["Olhos", "Garganta", "Genitais", "Bíceps"], correctAnswer: "Bíceps" },
                { text: "Em Krav Maga, a 'consciência situacional' (awareness) refere-se a:", options: ["Saber muitos golpes diferentes", "Estar ciente do ambiente e potenciais ameaças ao seu redor", "Ter boa condição física", "Conhecer as leis locais"], correctAnswer: "Estar ciente do ambiente e potenciais ameaças ao seu redor" }
            ]
        };

        /**
         * Carrega e exibe o formulário do quiz na página.
         */
        function loadQuiz() {
            if (!uiElements.quizContainer) return; 
            uiElements.quizContainer.innerHTML = ''; 
            uiElements.quizResult.style.display = 'none'; 

            const quizForm = document.createElement('form'); 
            quizForm.id = 'currentQuizForm';
            quizForm.className = 'card-body'; 

            const title = document.createElement('h3'); 
            title.className = 'h5 mb-4';
            title.textContent = sampleQuiz.title;
            quizForm.appendChild(title);

            sampleQuiz.questions.forEach((q, index) => {
                const questionDiv = document.createElement('div'); 
                questionDiv.className = 'mb-4';
                const questionText = document.createElement('p'); 
                questionText.className = 'fw-semibold';
                questionText.textContent = `${index + 1}. ${q.text}`;
                questionDiv.appendChild(questionText);

                q.options.forEach(opt => {
                    const optionDiv = document.createElement('div'); 
                    optionDiv.className = 'form-check';
                    const input = document.createElement('input'); 
                    input.className = 'form-check-input';
                    input.type = 'radio';
                    input.name = `question-${index}`; 
                    input.value = opt;
                    input.id = `q${index}-opt-${opt.replace(/\s+/g, '')}`; 
                    input.setAttribute('aria-label', opt); // ARIA label for accessibility
                    const label = document.createElement('label'); 
                    label.className = 'form-check-label small';
                    label.htmlFor = input.id;
                    label.textContent = opt;
                    optionDiv.appendChild(input);
                    optionDiv.appendChild(label);
                    questionDiv.appendChild(optionDiv);
                });
                quizForm.appendChild(questionDiv);
            });

            const submitButton = document.createElement('button'); 
            submitButton.type = 'submit';
            submitButton.className = 'btn btn-primary';
            submitButton.textContent = 'Enviar Respostas';
            quizForm.appendChild(submitButton);

            quizForm.addEventListener('submit', handleQuizSubmit); 
            uiElements.quizContainer.appendChild(quizForm); 
        }

        /**
         * Manipula a submissão do quiz, calcula a pontuação e exibe o resultado.
         * @param {Event} e - O objeto do evento de submissão.
         */
        function handleQuizSubmit(e) {
            e.preventDefault(); 
            let score = 0;
            sampleQuiz.questions.forEach((q, index) => {
                const selectedOption = document.querySelector(`input[name="question-${index}"]:checked`);
                if (selectedOption && selectedOption.value === q.correctAnswer) {
                    score++;
                }
            });
            if (uiElements.quizScoreDisplay) uiElements.quizScoreDisplay.textContent = `Você acertou ${score} de ${sampleQuiz.questions.length} perguntas.`;
            if (uiElements.quizResult) uiElements.quizResult.style.display = 'block'; 
            if (uiElements.quizContainer.querySelector('#currentQuizForm')) { 
                uiElements.quizContainer.querySelector('#currentQuizForm').style.display = 'none';
            }
            if(uiElements.retakeQuizButton) uiElements.retakeQuizButton.focus(); // Focus on retake button for accessibility
        }
        if (uiElements.retakeQuizButton) uiElements.retakeQuizButton.addEventListener('click', loadQuiz);

        /* Marcador: Funções de Emergência */
        let emergencyContacts = []; 

        /**
         * Configura os event listeners para o botão de adicionar contato de emergência e o botão de alerta.
         */
        function setupEmergencyButton() {
            if (uiElements.addContactButton) uiElements.addContactButton.addEventListener('click', handleAddEmergencyContact);
            if (uiElements.emergencyButton) uiElements.emergencyButton.addEventListener('click', toggleEmergencyAlert);
        }

        /**
         * Carrega os contatos de emergência do usuário do Firebase e os exibe na lista.
         * Usa `onValue` para escutar mudanças em tempo real nos contatos.
         */
        async function loadEmergencyContacts() {
            if (!currentUserId || !uiElements.contactsListDiv) return; 
            const contactsRefPath = `users/${currentUserId}/emergencyContacts`;
            const userContactsRef = ref(db, contactsRefPath); 
            
            onValue(userContactsRef, (snapshot) => {
                if (!uiElements.contactsListDiv) return; 
                uiElements.contactsListDiv.innerHTML = ''; 
                emergencyContacts = []; 
                if (snapshot.exists()) {
                    const contactsData = snapshot.val();
                    Object.keys(contactsData).forEach(key => { 
                        const contact = { id: key, ...contactsData[key] }; 
                        emergencyContacts.push(contact);
                        renderEmergencyContact(contact); 
                    });
                }
                if (emergencyContacts.length === 0 && uiElements.contactsListDiv) {
                     uiElements.contactsListDiv.innerHTML = '<p class="text-muted-light small">Nenhum contato de emergência adicionado.</p>';
                }
            });
        }

        /**
         * Renderiza um contato de emergência individual na lista da UI.
         * @param {object} contact - O objeto do contato contendo id, name, e detail.
         */
        function renderEmergencyContact(contact) {
            if (!uiElements.contactsListDiv) return;
            const placeholder = uiElements.contactsListDiv.querySelector('p.text-muted-light');
            if (placeholder) placeholder.remove(); 
            
            const div = document.createElement('div');
            div.className = 'd-flex justify-content-between align-items-center p-2 rounded mb-1 small'; 
            div.innerHTML = `
                <span class="text-break">${contact.name} (${contact.detail})</span>
                <button data-id="${contact.id}" class="btn btn-sm btn-link text-danger remove-contact-btn p-0 ms-2" aria-label="Remover contato ${contact.name}">
                    <i class="fas fa-trash" aria-hidden="true"></i>
                </button>`;
            uiElements.contactsListDiv.appendChild(div);
            const removeButton = div.querySelector('.remove-contact-btn');
            if (removeButton) removeButton.addEventListener('click', handleRemoveEmergencyContact);
        }

        /**
         * Manipula a adição de um novo contato de emergência.
         */
        async function handleAddEmergencyContact() {
            if (!currentUserId) { showMessage("Faça login para adicionar contatos.", true); return; }
            const name = uiElements.contactNameInput.value.trim(); 
            const detail = uiElements.contactDetailInput.value.trim();
            if (!name || !detail) { showMessage("Preencha nome e detalhe do contato.", true); return; }
            showLoader();
            try {
                const newContactRef = push(ref(db, `users/${currentUserId}/emergencyContacts`));
                await set(newContactRef, { name, detail }); 
                showMessage("Contato adicionado!");
                uiElements.contactNameInput.value = ''; 
                uiElements.contactDetailInput.value = '';
            }
            catch (error) {
                let errorMessage = "Ocorreu um erro desconhecido.";
                if (error && typeof error.message === 'string') { errorMessage = error.message; }
                showMessage("Erro ao adicionar contato: " + errorMessage, true);
            }
            finally { hideLoader(); }
        }

        /**
         * Manipula a remoção de um contato de emergência.
         * @param {Event} e - O objeto do evento de clique no botão de remover.
         */
        async function handleRemoveEmergencyContact(e) {
            const currentTarget = e.currentTarget; 
            if (!currentTarget || typeof currentTarget.dataset === 'undefined') return; 
            const contactId = currentTarget.dataset.id; 
            if (!currentUserId || !contactId) return;

            showMessage("Removendo contato... (Em um app real, haveria uma confirmação)", false); 
            showLoader();
            try { 
                await remove(ref(db, `users/${currentUserId}/emergencyContacts/${contactId}`)); 
                showMessage("Contato removido."); 
            }
            catch (error) {
                let errorMessage = "Ocorreu um erro desconhecido.";
                if (error && typeof error.message === 'string') { errorMessage = error.message; }
                showMessage("Erro ao remover contato: " + errorMessage, true);
            }
            finally { hideLoader(); }
        }

        /**
         * Alterna o estado do alerta de emergência (ativa ou cancela).
         */
        function toggleEmergencyAlert() {
            if (locationWatchId) { 
                handleCancelEmergencyAlert(); 
            } else { 
                handleActivateEmergencyAlert(); 
            }
        }

        /**
         * Ativa o alerta de emergência.
         * Inicia o rastreamento de geolocalização e simula o envio de notificações.
         */
        function handleActivateEmergencyAlert() {
            if (!currentUserId) { showMessage("Você precisa estar logada para usar o botão de emergência.", true); return; }
            if (emergencyContacts.length === 0) { 
                showMessage("Por favor, cadastre contatos de emergência primeiro na seção 'Início'.");
                navigateToPage('dashboard-page'); 
                const contactNameInputElement = uiElements.contactNameInput;
                if (contactNameInputElement && typeof contactNameInputElement.focus === 'function') contactNameInputElement.focus();
                return;
            }

            currentActiveAlertId = `alert_${new Date().getTime()}`; 
            const alertPath = `users/${currentUserId}/emergencyAlerts/${currentActiveAlertId}`; 

            showMessage("Ativando alerta e rastreando localização...");
            uiElements.emergencyButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ALERTA ATIVO - CANCELAR';
            uiElements.emergencyButton.classList.remove('btn-danger', 'emergency-button-pulse-animation'); 
            uiElements.emergencyButton.classList.add('btn-danger-active'); 
            if (uiElements.emergencyStatus) { 
                uiElements.emergencyStatus.textContent = "Rastreando localização... Tentando notificar contatos...";
                uiElements.emergencyStatus.classList.remove('d-none');
            }

            if (navigator.geolocation) { 
                set(ref(db, `${alertPath}/status`), "active"); 
                set(ref(db, `${alertPath}/startTime`), new Date().toISOString());
                set(ref(db, `${alertPath}/contactsNotified`), emergencyContacts.map(c => ({name: c.name, detail: c.detail})));

                locationWatchId = navigator.geolocation.watchPosition(
                    async (position) => { 
                        const { latitude, longitude, accuracy } = position.coords;
                        const locationData = { latitude, longitude, accuracy, timestamp: new Date().toISOString() };
                        try {
                            await set(ref(db, `${alertPath}/liveLocation`), locationData);
                            if (! (await get(child(ref(db), `${alertPath}/initialLocation`))).exists() ) {
                                await set(ref(db, `${alertPath}/initialLocation`), locationData);
                            }
                            console.log("Localização atualizada no Firebase:", locationData);

                            const mapLink = `https://www.google.com/maps?q=${latitude},${longitude}`; 
                            let userNameForAlert = "Usuária KMW"; 
                            try { 
                                const displayNameSnapshot = await get(ref(db, `users/${currentUserId}/profile/displayName`));
                                if (displayNameSnapshot.exists() && displayNameSnapshot.val().trim() !== "") {
                                    userNameForAlert = displayNameSnapshot.val().trim();
                                } else if (auth.currentUser && auth.currentUser.email) { 
                                     userNameForAlert = getUserDisplayNameForChat(auth.currentUser.email);
                                }
                            } catch (e) { console.warn("Erro ao buscar nome de exibição para alerta:", e); }
                            
                            if (uiElements.emergencyStatus) {
                                uiElements.emergencyStatus.textContent = `Alerta Ativo! Localização: Lat ${latitude.toFixed(3)}, Lon ${longitude.toFixed(3)}. Notificando contatos...`;
                            }

                            emergencyContacts.forEach(contact => {
                                let contactDetail = contact.detail.trim();
                                if (CALLMEBOT_WHATSAPP_API_KEY !== "YOUR_CALLMEBOT_WHATSAPP_APIKEY_HERE" && CALLMEBOT_WHATSAPP_API_KEY !== "" && /^\d{10,15}$/.test(contactDetail.replace(/\D/g,''))) {
                                    const phoneNumber = contactDetail.replace(/\D/g,''); 
                                    const whatsappMessage = `ALERTA URGENTE KMW! ${userNameForAlert} pode precisar de ajuda. Localização: ${mapLink} (Precisão: ${accuracy.toFixed(0)}m).`;
                                    const encodedWhatsappMessage = encodeURIComponent(whatsappMessage);
                                    const callMeBotWhatsappUrl = `https://api.callmebot.com/whatsapp.php?phone=${phoneNumber}&text=${encodedWhatsappMessage}&apikey=${CALLMEBOT_WHATSAPP_API_KEY}`;
                                    fetch(callMeBotWhatsappUrl).then(response => response.text()).then(data => console.log(`CallMeBot WhatsApp: Resposta para ${contact.name} (${phoneNumber}): `, data)).catch(err => console.error(`CallMeBot WhatsApp: Erro para ${contact.name}:`, err));
                                }
                                else if (contactDetail.startsWith('@')) {
                                    const telegramUsername = contactDetail.substring(1); 
                                    const telegramMessage = `ALERTA KMW de ${userNameForAlert}! Localização: ${mapLink} (Precisão: ${accuracy.toFixed(0)}m).`;
                                    const encodedTelegramMessage = encodeURIComponent(telegramMessage);
                                    const callMeBotTelegramUrl = `https://api.callmebot.com/text.php?user=${telegramUsername}&text=${encodedTelegramMessage}`;
                                    fetch(callMeBotTelegramUrl).then(response => response.text()).then(data => console.log(`CallMeBot Telegram: Resposta para ${contact.name} (${contactDetail}): `, data)).catch(err => console.error(`CallMeBot Telegram: Erro para ${contact.name}:`, err));
                                }
                            });
                        } catch (error) {
                            console.error("Erro ao salvar localização no Firebase:", error);
                            if (uiElements.emergencyStatus) uiElements.emergencyStatus.textContent = "Erro ao atualizar localização no servidor.";
                        }
                    },
                    (error) => { 
                        showMessage("Não foi possível obter sua localização: " + error.message, true);
                        if (uiElements.emergencyStatus) uiElements.emergencyStatus.textContent = "Erro ao obter localização: " + error.message;
                        handleCancelEmergencyAlert(); 
                    }, 
                    { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 } 
                );
            } else { 
                showMessage("Geolocalização não é suportada pelo seu navegador.", true);
                uiElements.emergencyButton.innerHTML = '<i class="fas fa-bell me-2"></i> EMITIR ALERTA';
                uiElements.emergencyButton.classList.remove('btn-danger-active'); 
                uiElements.emergencyButton.classList.add('btn-danger', 'emergency-button-pulse-animation');
                if (uiElements.emergencyStatus) uiElements.emergencyStatus.classList.add('d-none');
            }
        }

        /**
         * Cancela o alerta de emergência ativo.
         * Para o rastreamento de geolocalização e atualiza o status do alerta no Firebase.
         */
        function handleCancelEmergencyAlert() {
            if (locationWatchId) { 
                navigator.geolocation.clearWatch(locationWatchId); 
                locationWatchId = null; 
                showMessage("Alerta de emergência cancelado.");
                if (uiElements.emergencyStatus) { uiElements.emergencyStatus.textContent = "Alerta encerrado. Envio de localização interrompido.";}
                 if (currentUserId && currentActiveAlertId) {
                    const alertPath = `users/${currentUserId}/emergencyAlerts/${currentActiveAlertId}`;
                    set(ref(db, `${alertPath}/status`), "cancelled"); 
                    set(ref(db, `${alertPath}/endTime`), new Date().toISOString());
                    currentActiveAlertId = null; 
                }
            }
            uiElements.emergencyButton.innerHTML = '<i class="fas fa-bell me-2"></i> EMITIR ALERTA';
            uiElements.emergencyButton.classList.remove('btn-danger-active'); 
            uiElements.emergencyButton.classList.add('btn-danger', 'emergency-button-pulse-animation'); 
        }

        /* Marcador: Funções de Tema */

        /**
         * Aplica o tema (claro ou escuro) à página.
         * Atualiza o atributo `data-bs-theme` no `<html>`, o ícone do botão de tema e o localStorage.
         * @param {string} theme - O tema a ser aplicado ('light' ou 'dark').
         */
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-bs-theme', theme); 
            const iconClass = theme === 'light' ? 'fa-moon' : 'fa-sun'; 
            const oppositeThemeName = theme === 'light' ? 'escuro' : 'claro'; 
            if (uiElements.themeToggleButton) {
                uiElements.themeToggleButton.innerHTML = `<i class="fas ${iconClass}"></i>`;
                uiElements.themeToggleButton.setAttribute('aria-label', `Mudar para tema ${oppositeThemeName}`);
            }
            if (uiElements.themeToggleButtonMobile) {
                uiElements.themeToggleButtonMobile.innerHTML = `<i class="fas ${iconClass}"></i>`;
                uiElements.themeToggleButtonMobile.setAttribute('aria-label', `Mudar para tema ${oppositeThemeName}`);
            }
            localStorage.setItem('theme', theme); 
        }

        /**
         * Alterna entre o tema claro e escuro.
         */
        function toggleTheme() {
            let currentTheme = localStorage.getItem('theme') || 'dark'; 
            let newTheme = currentTheme === 'light' ? 'dark' : 'light'; 
            applyTheme(newTheme); 
        }

        /**
         * Configura a funcionalidade de tema, carregando o tema salvo e adicionando listeners aos botões.
         */
        function setupTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark'; 
            applyTheme(savedTheme); 
            if (uiElements.themeToggleButton) uiElements.themeToggleButton.addEventListener('click', toggleTheme);
            if (uiElements.themeToggleButtonMobile) uiElements.themeToggleButtonMobile.addEventListener('click', toggleTheme);
        }

        /* Marcador: Funções do Chatbot Sinais de Alerta */
        let warningChatHistory = []; 
        const SINAIS_DE_ALERTA_TEXTO = `
            "Olá! Sou uma assistente virtual com a persona de uma psicóloga experiente, especializada em ajudar a identificar sinais de alerta em relacionamentos que podem ser abusivos. Meu papel é te escutar com empatia e atenção, e te ajudar a refletir sobre sua situação, comparando o que você me contar EXCLUSIVAMENTE com a lista de comportamentos que tenho registrada.

            É muito importante que você saiba: eu não posso oferecer diagnósticos definitivos nem aconselhamento legal. Minha função é apenas analisar o que você descrever e indicar se algum dos sinais de alerta abaixo parece estar presente em seu relato. Quero que você se sinta em um espaço seguro e acolhedor para compartilhar.

            Lembre-se, a linguagem que usarei será sempre clara e acessível.

            Se você me contar algo que não se encaixe diretamente nos sinais que conheço, direi que, com base nas informações que você compartilhou, não parece corresponder aos comportamentos específicos que fui programada para identificar. No entanto, é fundamental que você sempre confie nos seus sentimentos e na sua intuição. Se algo não parece certo para você, ou se você se sente insegura ou infeliz, procurar apoio de um profissional de psicologia é sempre uma decisão válida e importante.

            Ao final de nossa conversa, se identificarmos algum sinal da lista, reforçarei a importância de buscar ajuda especializada para uma avaliação completa e suporte adequado. Caso não identifiquemos sinais da lista, ainda assim, sugiro que você continue atenta aos seus sentimentos e confie na sua percepção.

            Vamos aos sinais de alerta que posso ajudar a identificar:

            Sinais de Alerta em Relacionamentos:

            Controle Excessivo:

            Tenta controlar suas roupas, amizades, finanças, para onde você vai, com quem você fala.
            Exige senhas de redes sociais, celular ou e-mail.
            Monitora suas atividades online ou offline, querendo saber seus horários e localização constantemente.
            Isolamento Progressivo:

            Afasta você de amigos, colegas e familiares, criticando essas relações.
            Cria conflitos ou desconforto para que você se afaste de sua rede de apoio.
            Faz você se sentir culpada por querer passar tempo com outras pessoas.
            Ciúme Patológico e Possessividade:

            Demonstra ciúme desproporcional e frequente, muitas vezes sem motivo real.
            Faz acusações infundadas de traição ou flerte.
            Tenta controlar suas interações sociais, demonstrando desconfiança excessiva.
            Críticas Constantes e Desvalorização Sistemática:

            Faz humilhações, seja em particular ou em público.
            Desvaloriza suas opiniões, aparência, inteligência, sentimentos ou conquistas.
            Faz você se sentir inadequada, inferior ou constantemente culpada.
            Usa sarcasmo ou "brincadeiras" para te diminuir.
            Manipulação Emocional (Gaslighting):

            Distorce a realidade para fazer você duvidar de sua própria sanidade, memória ou percepção dos fatos.
            Nega eventos que aconteceram ("Isso nunca aconteceu", "Você está imaginando coisas") ou inventa situações.
            Faz você questionar sua própria capacidade de julgamento.
            Explosões de Raiva e Intimidação:

            Apresenta mudanças repentinas e intensas de humor, passando da calma para a fúria.
            Grita, xinga, usa palavras ofensivas ou depreciativas.
            Quebra objetos, bate em portas ou paredes, ou faz gestos agressivos para te intimidar.
            Usa olhares intimidadores, silêncio punitivo ou ameaças veladas ou diretas (contra você, seus filhos, animais de estimação, ou pessoas queridas).
            Responsabilização da Vítima (Blaming):

            Culpa você pelos problemas do relacionamento ou pelo próprio comportamento abusivo.
            Usa frases como: "Você me provocou", "Se você não fizesse X, eu não precisaria fazer Y", "Você me tira do sério".
            Faz você sentir que é responsável pelas reações negativas dele(a).
            Pressão ou Coerção Sexual:

            Ignora seus desejos, sentimentos e limites em relação à intimidade.
            Pressiona, insiste, manipula ou força você a atos sexuais contra sua vontade ou quando você não está confortável.
            Faz você se sentir culpada ou inadequada por não querer sexo.
            Controle Financeiro:

            Impede você de trabalhar ou estudar.
            Controla todo o dinheiro, mesmo o que você ganha, exigindo que você peça permissão ou justifique gastos.
            Cria dívidas em seu nome ou se apropria dos seus bens.
            Usa o dinheiro como forma de poder ou punição.
            Ameaças (explícitas ou implícitas):

            Ameaça te machucar fisicamente, te abandonar, se suicidar, ou tirar seus filhos.
            Ameaça expor segredos seus, te prejudicar no trabalho ou socialmente.
            Ameaça machucar pessoas queridas ou animais de estimação.
            Ciclo de Abuso (Tensão, Explosão, Lua de Mel):

            O relacionamento passa por fases: um aumento da tensão, uma explosão (abuso verbal, emocional, físico), seguida por um período de "lua de mel" com desculpas, promessas de mudança e comportamento carinhoso, apenas para o ciclo recomeçar.
            Essa fase de "lua de mel" pode te confundir e te dar esperanças de que as coisas vão melhorar.
            Invasão de Privacidade e Stalking:

            Mexe em seus pertences pessoais, lê suas mensagens, e-mails ou diário sem permissão.
            Segue você, aparece em lugares inesperados, ou monitora seus movimentos de forma obsessiva, mesmo que virtualmente.
        `;

        /**
         * Inicializa o chatbot de Sinais de Alerta.
         */
        function initializeWarningChatbot() {
            if (!uiElements.chatMessagesWarning || !uiElements.chatInputWarning || !uiElements.sendWarningChatButton || !uiElements.chatbotPostInteractionLinks) {
                console.warn("Elementos do chatbot de Sinais de Alerta não encontrados."); return;
            }
            uiElements.chatMessagesWarning.innerHTML = ''; 
            warningChatHistory = []; 
            uiElements.chatbotPostInteractionLinks.style.display = 'none'; 

            const welcomeMessage = "Olá! Sou sua analista virtual. Estou aqui para ajudar a refletir sobre seu relacionamento com base em alguns sinais de alerta. Como posso ajudar você hoje?";
            displayChatMessageWarning(welcomeMessage, 'bot'); 
            // Adiciona a mensagem de boas-vindas ao histórico para dar contexto ao modelo
            warningChatHistory.push({ role: "model", parts: [{ text: welcomeMessage }] }); 

            // Recria os listeners para evitar duplicação
            const newSendButton = uiElements.sendWarningChatButton.cloneNode(true);
            uiElements.sendWarningChatButton.parentNode.replaceChild(newSendButton, uiElements.sendWarningChatButton);
            uiElements.sendWarningChatButton = newSendButton; 
            
            const newChatInput = uiElements.chatInputWarning.cloneNode(true);
            uiElements.chatInputWarning.parentNode.replaceChild(newChatInput, uiElements.chatInputWarning);
            uiElements.chatInputWarning = newChatInput; 
            
            uiElements.sendWarningChatButton.addEventListener('click', handleSendWarningChatMessage);
            uiElements.chatInputWarning.addEventListener('keypress', function(e) { if (e.key === 'Enter') { handleSendWarningChatMessage(); } });
        }

        /**
         * Exibe uma mensagem na interface do chat de Sinais de Alerta.
         */
        function displayChatMessageWarning(message, sender, isLoading = false) {
            if (!uiElements.chatMessagesWarning) return;
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', sender); 
            if (isLoading) { 
                messageElement.classList.add('loading');
                messageElement.innerHTML = '<div class="dot-flashing"></div>';
            } else {
                messageElement.textContent = message; 
            }
            uiElements.chatMessagesWarning.appendChild(messageElement);
            uiElements.chatMessagesWarning.scrollTop = uiElements.chatMessagesWarning.scrollHeight; 
        }

        /**
         * Manipula o envio de uma mensagem do usuário para o chatbot de Sinais de Alerta.
         * CORRIGIDO: Usa a API Fetch para se comunicar com o Gemini.
         */
        async function handleSendWarningChatMessage() {
            if (!uiElements.chatInputWarning || !uiElements.chatMessagesWarning) return;
            const userMessage = uiElements.chatInputWarning.value.trim();
            if (userMessage === "") return; 

            displayChatMessageWarning(userMessage, 'user'); 
            warningChatHistory.push({ role: "user", parts: [{ text: userMessage }] }); 
            uiElements.chatInputWarning.value = ""; 
            
            if (uiElements.chatbotPostInteractionLinks) {
                uiElements.chatbotPostInteractionLinks.style.display = 'none';
            }
            displayChatMessageWarning('', 'bot', true); 
            const loadingElement = uiElements.chatMessagesWarning.lastChild; 

            // O prompt do sistema define a persona e as regras do bot
            const systemPrompt = {
                role: "user",
                parts: [{ text: SINAIS_DE_ALERTA_TEXTO }]
            };

            // O histórico enviado para a API inclui o prompt do sistema para manter o contexto
            const historyForAPI = [systemPrompt, ...warningChatHistory];

            const payload = {
                contents: historyForAPI
            };

            // A chave da API é deixada em branco para ser injetada pelo ambiente
            const apiKey = "AIzaSyByPohV8gRrDYwFQiSKSd6kWCHAMH9TOH4";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    console.error("API Error:", response.status, errorDetails);
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                let botResponse = "Desculpe, não consegui processar sua mensagem no momento.";

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    botResponse = result.candidates[0].content.parts[0].text;
                } else {
                    console.warn("A resposta da API não continha o conteúdo esperado.", result);
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        botResponse = `Não foi possível gerar uma resposta devido a: ${result.promptFeedback.blockReason}. Por favor, reformule sua pergunta.`;
                    }
                }

                if (loadingElement) loadingElement.remove();
                displayChatMessageWarning(botResponse, 'bot');
                warningChatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                
                if (uiElements.chatbotPostInteractionLinks) {
                    uiElements.chatbotPostInteractionLinks.style.display = 'block';
                }

            } catch (error) {
                console.error("Erro ao enviar mensagem para API Gemini:", error);
                if (loadingElement) loadingElement.remove();
                displayChatMessageWarning("Desculpe, ocorreu um erro ao tentar obter uma resposta. Por favor, tente novamente mais tarde.", 'bot');
                if (uiElements.chatbotPostInteractionLinks) {
                    uiElements.chatbotPostInteractionLinks.style.display = 'block';
                }
            }
        }

        
        /**
         * Carrega as mensagens do chat da comunidade.
         */
        function loadCommunityChatMessages() {
            if (!currentUserId || !uiElements.communityChatMessagesArea) { 
                 if (uiElements.communityChatMessagesArea) { 
                    uiElements.communityChatMessagesArea.innerHTML = '<p class="text-muted-light small p-2 text-center">Faça login para ver o chat.</p>';
                } return;
            }
            if (communityChatMessagesListener) return; 

            if (uiElements.communityChatMessagesArea) { 
                 uiElements.communityChatMessagesArea.innerHTML = '<p class="text-muted-light small p-2 text-center">Carregando mensagens...</p>'; 
            }
            const queryRef = query(communityChatMessagesRef, orderByChild('timestamp'), limitToLast(50));
            
            communityChatMessagesListener = onValue(queryRef, (snapshot) => {
                if (!uiElements.communityChatMessagesArea) return; 
                
                if (uiElements.communityChatMessagesArea.firstChild && uiElements.communityChatMessagesArea.firstChild.textContent !== "Carregando mensagens...") {
                     uiElements.communityChatMessagesArea.innerHTML = '';
                } else if (uiElements.communityChatMessagesArea.firstChild && uiElements.communityChatMessagesArea.firstChild.textContent === "Carregando mensagens..."){
                     uiElements.communityChatMessagesArea.innerHTML = ''; 
                }

                if (snapshot.exists()) { 
                    let hasMessages = false;
                    snapshot.forEach((childSnapshot) => { 
                        hasMessages = true;
                        const messageId = childSnapshot.key; 
                        const messageData = childSnapshot.val();
                        displayCommunityChatMessage(messageData, messageId); 
                    });
                    if (!hasMessages && uiElements.communityChatMessagesArea) { 
                        uiElements.communityChatMessagesArea.innerHTML = '<p class="text-muted-light small p-2 text-center">Nenhuma mensagem ainda. Seja a primeira a conversar!</p>';
                    }
                } else { 
                    if (uiElements.communityChatMessagesArea) {
                        uiElements.communityChatMessagesArea.innerHTML = '<p class="text-muted-light small p-2 text-center">Nenhuma mensagem ainda. Seja a primeira a conversar!</p>';
                    }
                }
                if (uiElements.communityChatMessagesArea) {
                    uiElements.communityChatMessagesArea.scrollTop = uiElements.communityChatMessagesArea.scrollHeight;
                }
            }, (error) => { 
                console.error("Erro ao carregar mensagens do chat da comunidade:", error);
                if (uiElements.communityChatMessagesArea) {
                    uiElements.communityChatMessagesArea.innerHTML = '<p class="text-danger small p-2 text-center">Erro ao carregar o chat.</p>';
                }
            });
        }

        /**
         * Remove o listener de mensagens do chat da comunidade.
         */
        function detachCommunityChatListener() {
            if (communityChatMessagesListener && communityChatMessagesRef) { 
                off(communityChatMessagesRef, 'value', communityChatMessagesListener); 
                communityChatMessagesListener = null; 
                console.log("Community chat listener detached.");
            }
        }

        /* Marcador: Funções da Página de Suporte */

        /**
         * Manipula o clique no botão "Encontrar Ajuda Perto de Mim".
         */
        function handleFindSupportNearMe() {
            showLoader();
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    const deamQuery = `https://www.google.com/maps/search/?api=1&query=delegacia+da+mulher+perto+de+${latitude},${longitude}`;
                    const cramQuery = `https://www.google.com/maps/search/?api=1&query=centro+de+referencia+da+mulher+perto+de+${latitude},${longitude}`;
                    
                    let deamWindow = window.open(deamQuery, '_blank');
                    let cramWindow = window.open(cramQuery, '_blank');
                    hideLoader();

                    if (!deamWindow || deamWindow.closed || typeof deamWindow.closed == 'undefined' || 
                        !cramWindow || cramWindow.closed || typeof cramWindow.closed == 'undefined') {
                        // Attempt to inform about pop-up blockers
                        showMessage("Tentamos abrir os mapas de ajuda, mas parece que seu navegador bloqueou as janelas pop-up. Por favor, verifique as configurações do seu navegador e tente novamente. As buscas são: 'delegacia da mulher perto de mim' e 'centro de referencia da mulher perto de mim'.", true);
                    } else {
                        showMessage("Abrindo o mapa para encontrar Delegacias da Mulher (DEAMs) e Centros de Referência próximos a você.");
                    }

                }, () => { // Error callback for getCurrentPosition
                    hideLoader();
                    showMessage("Não foi possível obter sua localização. Verifique as permissões do seu navegador e tente novamente.", true);
                }, { timeout: 10000, enableHighAccuracy: true });
            } else {
                hideLoader();
                showMessage("Geolocalização não é suportada pelo seu navegador. Não é possível buscar ajuda próxima automaticamente.", true);
            }
        }

        /**
         * Configura os event listeners para a página de suporte.
         */
        function setupSupportPageEventListeners() {
            if (uiElements.findSupportNearMeButton) {
                uiElements.findSupportNearMeButton.addEventListener('click', handleFindSupportNearMe);
            }
        }


        /* Marcador: Inicialização do Aplicativo */

        /**
         * Função principal que configura todos os aspectos iniciais do aplicativo.
         */
        function initializeAppLogic() {
            if (uiElements.currentYearEl) uiElements.currentYearEl.textContent = new Date().getFullYear();
            setupNavigation();
            setupAuthEventListeners();
            setupNotesEventListeners();
            setupEmergencyButton();
            setupTheme();
            // setupCommunityChat(); // This function was not defined, assuming it's part of a larger context or a typo. If needed, define it.
            setupDisplayNamePrompt(); 
            setupSupportPageEventListeners(); 

            // Initialize community chat if elements exist
            if (uiElements.communityChatInput && uiElements.sendCommunityChatMessageButton) {
                uiElements.sendCommunityChatMessageButton.addEventListener('click', handleSendCommunityChatMessage);
                uiElements.communityChatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleSendCommunityChatMessage();
                });
            }
        }

        // Example: Define handleSendCommunityChatMessage and displayCommunityChatMessage if they were intended
        async function handleSendCommunityChatMessage() {
            if (!currentUserId || !uiElements.communityChatInput || !currentUserEmail) {
                showMessage("Você precisa estar logado para enviar mensagens.", true);
                return;
            }
            const messageText = uiElements.communityChatInput.value.trim();
            if (messageText === "") return;

            let displayName = getUserDisplayNameForChat(currentUserEmail); 
            try {
                const nameSnapshot = await get(ref(db, `users/${currentUserId}/profile/displayName`));
                if (nameSnapshot.exists() && nameSnapshot.val().trim() !== "") {
                    displayName = nameSnapshot.val().trim();
                }
            } catch(e) { console.warn("Could not fetch display name for chat, using default."); }


            const messageData = {
                userId: currentUserId,
                userEmail: currentUserEmail, 
                displayName: displayName,
                text: messageText,
                timestamp: new Date().toISOString()
            };

            try {
                const newMessageRef = push(communityChatMessagesRef);
                await set(newMessageRef, messageData);
                uiElements.communityChatInput.value = ""; 
            } catch (error) {
                console.error("Erro ao enviar mensagem no chat da comunidade:", error);
                showMessage("Erro ao enviar mensagem. Tente novamente.", true);
            }
        }

        function displayCommunityChatMessage(messageData, messageId) {
            if (!uiElements.communityChatMessagesArea || !messageData) return;

            const messageItem = document.createElement('div');
            messageItem.classList.add('community-chat-message-item');
            messageItem.dataset.messageId = messageId; 

            const isSentMessage = messageData.userId === currentUserId;
            messageItem.classList.add(isSentMessage ? 'sent' : 'received');

            const messageMeta = document.createElement('div');
            messageMeta.classList.add('message-meta');
            
            const senderNameSpan = document.createElement('span');
            senderNameSpan.classList.add('sender-name');
            senderNameSpan.textContent = isSentMessage ? "Você" : (messageData.displayName || getUserDisplayNameForChat(messageData.userEmail));

            const timestampSpan = document.createElement('span');
            timestampSpan.classList.add('message-timestamp');
            timestampSpan.textContent = getFormattedTimestamp(messageData.timestamp);

            messageMeta.appendChild(senderNameSpan);
            messageMeta.appendChild(timestampSpan);

            const messageTextContent = document.createElement('div');
            messageTextContent.classList.add('message-text-content');
            messageTextContent.textContent = messageData.text;

            messageItem.appendChild(messageMeta);
            messageItem.appendChild(messageTextContent);
            
            const placeholder = uiElements.communityChatMessagesArea.querySelector('p.text-muted-light');
            if (placeholder) placeholder.remove();

            uiElements.communityChatMessagesArea.appendChild(messageItem);
            uiElements.communityChatMessagesArea.scrollTop = uiElements.communityChatMessagesArea.scrollHeight;
        }


        document.addEventListener('DOMContentLoaded', () => {
            initializeAppLogic(); 
            
            const currentActivePage = Array.from(pageSections).find(s => s.classList.contains('active'));
             if (currentActivePage && currentActivePage.id === 'auth-page' && !auth.currentUser) {
                const firstLoginInput = uiElements.loginForm ? uiElements.loginForm.querySelector('#loginEmail') : null;
                if (firstLoginInput && typeof firstLoginInput.focus === 'function') {
                     setTimeout(() => firstLoginInput.focus(), 0);
                }
            } else if (currentActivePage && currentActivePage.id === 'warnings-page') {
                initializeWarningChatbot();
            } else if (currentActivePage && currentActivePage.id === 'dashboard-page' && auth.currentUser) {
                loadAndSetDisplayName(); 
                loadCommunityChatMessages(); 
            }
             else if (!currentActivePage && !auth.currentUser) { 
                 navigateToPage('auth-page'); 
            } else if (!currentActivePage && auth.currentUser) { 
                 navigateToPage('dashboard-page');
            }
        });

    </script>
</body>
</html>
